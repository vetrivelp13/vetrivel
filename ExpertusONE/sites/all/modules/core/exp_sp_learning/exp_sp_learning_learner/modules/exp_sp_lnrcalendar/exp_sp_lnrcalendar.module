<?php

/**
 * Implementation of hook_block_info().
 */
function exp_sp_lnrcalendar_block_info() {
  try{
  $blocks = array();
  $blocks['tab_my_calendar'] = array(
    'info' => t('LBL008'),
  	'cache' => DRUPAL_CACHE_PER_ROLE,
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => 'learning/enrollment-search'
  );
  $blocks['mycalendar_mylearning'] = array(
  		'info' => t('New theme MyCalendar'),
  		'cache' => DRUPAL_CACHE_PER_ROLE,
  		'visibility' => BLOCK_VISIBILITY_LISTED,
  		'pages' => 'learning/enrollment-search'
  );
  return $blocks;
  }catch (Exception $ex) {
    watchdog_exception('exp_sp_lnrcalendar_block_info', $ex);
    expertusErrorThrow($ex);
  } 
}

/**
 * Implementation of hook_menu().
 */
function exp_sp_lnrcalendar_menu() {
  try{
   $items = array();
   
   $items['ajax/calendar-xml-list/%/%'] = array(
	'page callback' => 'getClassList',
    'access arguments' => array('expertus learner'),
   	'page arguments' => array(2,3),	
    'type' => MENU_CALLBACK,
   );
   return $items;
   }catch (Exception $ex) {
    watchdog_exception('exp_sp_lnrcalendar_menu', $ex);
    expertusErrorThrow($ex);
  } 
}

/**
 * Implementation of hook_block_view().
 */
function exp_sp_lnrcalendar_block_view($delta = ''){
	global $tTrack;
	$tTrack['end']['before_calendar'] = (microtime(true) - $tTrack['start']['index_start']);
	$tTrack['start']['calendar'] = microtime(true);
  try{
  
 // require_once('exp_sp_lnrcalendar.inc');
  $header_optional = array('type' => 'file', 'scope' => 'header', 'group' => JS_LIBRARY);
   $css_module_optional = array('type' => 'file', 'group' => CSS_DEFAULT);
  $css_theme_optional = array('type' => 'file', 'group' => CSS_THEME);
  $js_module_optional = array('type' => 'file', 'group' => JS_DEFAULT);
  global $theme_key, $user_preference;
  $block = array();
  switch ($delta) {
  case 'tab_my_calendar':
  	drupal_add_library('system', 'ui.datepicker');
  	  drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.expertus.calendar.js',$header_optional);
      drupal_add_js(drupal_get_path('module', 'exp_sp_lnrcalendar') .'/exp_sp_lnrcalendar.js', $js_module_optional);
      drupal_add_js(drupal_get_path('module', 'exp_sp_administration_learning') . '/jquery.jscrollpane.js', $js_module_optional);
   if($theme_key == 'expertusoneV2') {
 //NEWUI THEME STYLE SHEET
      drupal_add_css(drupal_get_path('module', 'exp_sp_core').'/css/calender_style_v2.css',$css_theme_optional);
      drupal_add_css(drupal_get_path('module', 'exp_sp_lnrcalendar') .'/exp_sp_lnrcalendar_v2.css', $css_theme_optional);
  }else{
  	drupal_add_css(drupal_get_path('module', 'exp_sp_core').'/css/calender_style.css',$css_theme_optional);
      drupal_add_css(drupal_get_path('module', 'exp_sp_lnrcalendar') .'/exp_sp_lnrcalendar.css', $css_theme_optional);
  }
      $obj = new stdClass();
      $xml = '';
      $isInstructor=0;
 			if(array_key_exists ('tab_my_calendar',$_SESSION['MyLearn_Pref']['mylearning_right'])){
				$xml = ''; //getClassList(1);
				$isInstructor=is_instructor(getSltpersonUserId());
			}
      
      
      $block['subject']= t("LBL008");
      // Content preparation based on the widget preference
          $html="<input type='hidden' id='catalog-admin-cal-xml' value='".$xml."'></input>";
	      $html.= "<div id='catalog-admin-style' class='cal-widget-height'>";
	      $html.= "<div id='catalog-admin-cal'></div>";
	      $html.="<div class='sp_rowseparator'></div>";
	      $html.= "</div><div class='splitter' style='height: 0px;'>&nbsp;</div>";
	      $html.="<div id='catalog-admin-cal-legend'>";
	    /*$html.="<div class='first-row'><div class='first-row-cell'><span class='eventdot todaydot'>&nbsp;</span><span class='mycalendar-class-types'>".t('LBL031')."</span>&nbsp;";
	      $html.="<span class='eventdot regdot'>&nbsp;</span><span class='mycalendar-class-types'>".t('LBL032')."</span>&nbsp;";
	      $html.="<span class='eventdot updot'>&nbsp;</span><span class='mycalendar-class-types'>".t('LBL033')."</span>&nbsp;";
	      $html.="<span class='eventdot compdot'>&nbsp;</span><span class='mycalendar-class-types'>".t('LBL034')."</span>&nbsp;";
	      if (isset($_SESSION['availableFunctionalities']->instructordesk) || 1==1){
	      	$html.="&nbsp;&nbsp;<span class='eventdot instructordot'>&nbsp;</span><span class='mycalendar-class-types'>".t('LBL086')."</span></div></div>";
	      }else{
	      	$html.="</div></div>";
	      }*/
	     $html.="<div class='first-row'><div class='first-row-cell'>";
	     $html.="<table cellspacing=0 cellpadding=0 border=0>";
	     $html.="<tr class='cal-legent-tr-height'>";
	     $html.="<td class='cal-legent-td'><span class='eventdot todaydot'>&nbsp;</span><span class='mycalendar-class-types'>".t('LBL031')."</span></td>";
	     $html.="<td class='cal-legent-td'><span class='eventdot updot'>&nbsp;</span><span class='mycalendar-class-types'>".t('LBL033')."</span></td>";
	     if ((isset($_SESSION['availableFunctionalities']->exp_sp_instructor_desk))&& $isInstructor==1 ){
	     	$html.="<td class='cal-legent-td'><span class='eventdot instructordot'>&nbsp;</span><span class='mycalendar-class-types'>".t('Instructor')."</span></td>";
	     	$html.="</tr>";
	      $html.="<tr class='cal-legent-tr-height'>";
	      $html.="<td class='cal-legent-td'><span class='eventdot regdot'>&nbsp;</span><span class='mycalendar-class-types'>".t('Registered')."</span></td>";
	      $html.="<td class='cal-legent-td'><span class='eventdot compdot'>&nbsp;</span><span class='mycalendar-class-types'>".t('Completed')."</span></td>";
	      $html.="<td class='cal-legent-td'>&nbsp;</td>";
	      $html.="</tr>";
	     }else{
	     	$html.="<td class='cal-legent-td'><span class='eventdot regdot'>&nbsp;</span><span class='mycalendar-class-types'>".t('Registered')."</span></td>";
	     	$html.="</tr>";
	      $html.="<tr class='cal-legent-tr-height'>";
	      $html.="<td class='cal-legent-td'><span class='eventdot compdot'>&nbsp;</span><span class='mycalendar-class-types'>".t('Completed')."</span></td>";
	      $html.="<td class='cal-legent-td'>&nbsp;</td>";
	      $html.="</tr>";
	     }
	     
	     $html.="</table>";
	     $html.="</div></div>";
	      
	      $html.="</div>";
	      
	      $html.="<div id='catalog-admin-cal-session-details' class='session-details-list'>";
	      $html.="</div>";
	     if ($theme_key == 'expertusoneV2' && !isset($user_preference['mylearning_right']['tab_my_calendar'])) { 
	     	$block_html="";
	     } else {
	      	$block_html=$html;
	     }    
      $block['content']= $block_html;
      $tTrack['end']['calendar'] = (microtime(true) - $tTrack['start']['calendar']);
      break;
  case 'mycalendar_mylearning':
  	drupal_add_library('system', 'ui.datepicker');
  	drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.expertus.calendar.js',$header_optional);
  	drupal_add_js(drupal_get_path('module', 'exp_sp_lnrcalendar') .'/exp_sp_lnrcalendar.js', $js_module_optional);
  	drupal_add_js(drupal_get_path('module', 'exp_sp_administration_learning') . '/jquery.jscrollpane.js', $js_module_optional);
  	$css_module_optional = array('type' => 'file', 'group' => CSS_DEFAULT);
  	drupal_add_css(drupal_get_path('module', 'exp_sp_core').'/css/calender_style_v2.css',$css_theme_optional);
  	drupal_add_css(drupal_get_path('module', 'exp_sp_lnrcalendar') .'/exp_sp_lnrcalendar_v2.css', $css_theme_optional);
  	drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/exp_sp_mylearning.js',$js_module_optional);
  	includeJqGridJsCss();
  	$block['subject'] = '';
  	$xml = '';
  	$isInstructor=0;
  	expDebug::dPrint('testest'.print_r($_SESSION['MyLearn_Pref'],true),5);
  	
  	$content = '<div id="user-mycalendar-settings">
					<div class="vtip" title="'.t("LBL008").'"><div class="calendaricon" onclick="showUserMyCalendarSettings()"><span class="my-mycalendar-arrow-new" id="my-mycalendar-arrow-new"></span></div>
					</div></div>';

  	$block['content'] = $content;
  	break;
  }
  return $block;
  }catch (Exception $ex) {
    watchdog_exception('exp_sp_lnrcalendar_block_view', $ex);
    expertusErrorThrow($ex);
  } 
}

/**
 * Callback of AJAX Call to get the class list
 */
function getClassList($date = 0, $mode = ''){
  try{
  	$curDate = date('Y-m');
  	
    require_once('exp_sp_lnrcalendar.inc');
    //make the db query to fetch the list of ilt and vc
    $result=getUpcomingTrainings($date, $mode);
    return drupal_json_output($result);
    exit();
    $cnt = count($result);
    expDebug::dPrint('count of trainings'.$cnt);
    $xml='<Items>';
    for($i=0; $i < $cnt ; $i++){
    	$xml.="<Item>";
    	//$xml.="<Id>".$result[$i]['id']."</Id>";
    	$xml.="<classid>".$result[$i]['classid']."</classid>";
    	$xml.="<title>".str_replace('&','&amp;',$result[$i]['title'])."</title>";
    	$xml.="<eventdate>".$result[$i]['eventdate']."</eventdate>";
    	$xml.="<code>".str_replace('&','&amp;',$result[$i]['code'])."</code>";
    	$xml.="<regstatus>".$result[$i]['reg_status']."</regstatus>";
    	$xml.="<compstatus>".$result[$i]['comp_status']."</compstatus>";
    	//$xml.="<mroflag>".$result[$i]['mro_flag']."</mroflag>";
    	$xml.="<session_timezone>".$result[$i]['session_timezone']."</session_timezone>";
    	$xml.="<user_timezone>".$result[$i]['user_timezone']."</user_timezone>";
    	$xml.="<statustext>".$result[$i]['statustext']."</statustext>";
    	$xml.="<startdatetime>".$result[$i]['startdatetime'].' ' .$result[$i]['session_start_time_form']."</startdatetime>";
    	$xml.="<enddatetime>".$result[$i]['enddatetime'].' ' .$result[$i]['session_end_time_form']."</enddatetime>";
    	$xml.="<usertimezonecode>".$result[$i]['usertimezonecode']."</usertimezonecode>";
    	$xml.="<session_timezone_code>".$result[$i]['session_timezone_code']."</session_timezone_code>";
    	$xml.="<user_tzcode>".$result[$i]['user_tzcode']."</user_tzcode>";
    	$xml.="<tz_code>".$result[$i]['tz_code']."</tz_code>";
    	// Added by Vincent on Oct 30, 2013 for #0028593
    	$xml.="<ilteventdate>".$result[$i]['ilt_eventdate']."</ilteventdate>";
    	$xml.="<iltstartdatetime>".$result[$i]['ilt_startdatetime'].' ' .$result[$i]['ilt_session_start_time_form']."</iltstartdatetime>";
    	$xml.="<iltenddatetime>".$result[$i]['ilt_enddatetime'].' ' .$result[$i]['ilt_session_end_time_form']."</iltenddatetime>";
    	$xml.="<deliverytype>".$result[$i]['deliverytype']."</deliverytype>";
    	$xml.="<iltdatewithouttime>".$result[$i]['ilt_date_without_time']."</iltdatewithouttime>";
    	
    	$xml.="<myclass>".$result[$i]['myclass']."</myclass>";    	
    	$xml.="<inslnrclsdetails>".$result[$i]['inslnrclsdetails']."</inslnrclsdetails>";
    	$xml.="<classtypeicon>".$result[$i]['calendar_class_type_icon']."</classtypeicon>";
    	$xml.="<datewithouttime>".$result[$i]['date_without_time']."</datewithouttime>";
    	$xml.="</Item>";
    }
    expDebug::dPrint('xml file to be displayed'.print_r($xml,true),4);
    $xml.="</Items>";
    
    if($block==1){
      return $xml;
    } else {
      echo $xml;
    }
  }catch (Exception $ex) {
    watchdog_exception('getClassList', $ex);
    expertusErrorThrow($ex);
  } 
}
?>