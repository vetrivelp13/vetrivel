<?php
/**
 * @file
 * A block module that displays recent blog and forum posts.
 */
 
include_once $_SERVER["DOCUMENT_ROOT"]."/sites/all/modules/core/exp_sp_core/modules/exp_sp_administration/exp_sp_admincalendar/exp_sp_admincalendar.inc";
 
 function exp_sp_admincalendar_init()
 {
	global $theme_key;
 	if(request_uri() == "/?q=admincalendar")
 	{
	 	$header_optional = array('type' => 'file', 'scope' => 'header', 'group' => JS_LIBRARY);
	 	drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/AbstractDetailsWidget.js');
	    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/AbstractManager.js');
	  	drupal_add_js(drupal_get_path("module", "exp_sp_admincalendar") ."/jquery.min.js");
	  	drupal_add_css(drupal_get_path("module", "exp_sp_admincalendar") ."/fullcalendar.css");
	  	drupal_add_css(drupal_get_path("module", "exp_sp_admincalendar") ."/css/administration_calendar.css"); 
	    //drupal_add_css(drupal_get_path("module", "exp_sp_admincalendar") ."/fullcalendar.print.css","print");
	    //drupal_add_js(drupal_get_path("module", "exp_sp_admincalendar") ."/gcal.js");
	    drupal_add_js(drupal_get_path("module", "exp_sp_admincalendar") ."/moment.min.js");
	    drupal_add_js(drupal_get_path("module", "exp_sp_admincalendar") ."/fullcalendar.js");
	    drupal_add_js(drupal_get_path("module", "exp_sp_admincalendar") ."/expertusadmincalendar.js");
	    drupal_add_js(drupal_get_path("module", "exp_sp_admincalendar") ."/fc-lang-all.js");
		drupal_add_js(drupal_get_path("module", "exp_sp_administration") ."/exp_sp_administration.js");
	  	drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_core.js',$header_optional);
		drupal_add_js(drupal_get_path("module", "exp_sp_lnrsearch") ."/jquery.cookie.js");
		    
	    // drupal_add_library('system', 'ui.datepicker');
	    drupal_add_js('misc/ui/jquery.ui.datepicker.min.js');
		drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/timepicker.js');
	    drupal_add_library('system', 'ui.slider');
	    drupal_add_library('system', 'ui.tabs');
		drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jqgrid/jquery.jqGrid.js');
	    
	    // JQ Grid supported file includes
	    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jqgrid/js/min/grid.locale-en-min.js',$header_optional);
	    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jqgrid/js/grid.base.js',$header_optional);
	    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jqgrid/js/min/grid.common-min.js',$header_optional);
	    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jqgrid/js/min/grid.subgrid-min.js',$header_optional);
	    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jqgrid/js/grid.custom.js',$header_optional);
	    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jqgrid/js/min/grid.import-min.js',$header_optional);
	    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jqgrid/js/min/jquery.fmatter-min.js',$header_optional);
	    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/qtippopup.js',$header_optional);
    }
    // attach calendar perm list in settings
 }
 
function exp_sp_admincalendar_menu() {

  $menuitems['admincalendar'] = array(
	'title' => '',
	'page callback' => 'exp_sp_admincalendar_page_callback',
	'access callback' => 'admincalendar_user_access',
    'type' => MENU_CALLBACK,
    );
    
  $menuitems['administration/calendarviewapi'] = array(
  	'title' => 'Calendar View API',
  	'page callback' => 'getCalendarViewDataJson',
  	'access callback' => 'admincalendar_user_access',
  	'type' => MENU_CALLBACK,
  	'file' => 'exp_sp_admincalendar.inc'
  );
 
      
  $menuitems['administration/calendarUpdateData'] = array(
  	'title' => 'Calendar Data Update API',
  	'page callback' => 'updateObjectData',
  	'access callback' => 'admincalendar_user_access',
  	'type' => MENU_CALLBACK,
  	'file' => 'exp_sp_admincalendar.inc'
  );
 
  
  $menuitems['administration/viewdaywisereportorderlocations'] = array(
  	'title' => 'Daywise Data API',
  	'page callback' => 'viewdaywisereportorderlocations',
  	'access callback' => 'admincalendar_user_access',
  	'type' => MENU_CALLBACK,
  	'file' => 'exp_sp_admincalendar.inc'
  );
  
  $menuitems['administration/viewreportsforcalendar'] = array(
  	'title' => 'Daywise Data API',
  	'page callback' => 'getReportsForCalendar',
  	'access callback' => 'admincalendar_user_access',
  	'type' => MENU_CALLBACK,
  	'file' => 'exp_sp_admincalendar.inc'
  );
  $menuitems['administration/calendar/settings'] = array(
   	'title' => 'Admin calendar settings',
   	'page callback' => 'getAdminCalendarSettings',
   	'access callback' => 'admincalendar_user_access',
   	'type' => MENU_CALLBACK,
   	'file' => 'exp_sp_admincalendar.inc'
  );
    
  $menuitems['administration/calendar/order-update/%/%'] = array(
   	'title' => 'Admin calendar settings',
   	'page callback' => 'updateOrderSatus',
   	'page arguments' => array(3, 4),
   	'access callback' => 'admincalendar_user_access',
	'type' => MENU_CALLBACK,
    'file' => 'exp_sp_admincalendar.inc'
   );
  $menuitems['administration/calendar-autocomplete'] = array(
  		'title' => 'Search Calendar Autocomplete',
  		'page callback' => 'getSearchCalendarAutoComplete',
  		'access callback' => 'admincalendar_user_access',
  		'type' => MENU_CALLBACK,
  		'file' => 'exp_sp_admincalendar.inc'
  );
  
  $menuitems['administration/calendar/update-preference'] = array(
  		'title' => 'set Calendar User Preference',
  		'page callback' => 'setAdminCalendarPreference',
  		'access callback' => 'admincalendar_user_access',
  		'type' => MENU_CALLBACK,
  		'file' => 'exp_sp_admincalendar.inc'
  );
  return $menuitems;
}

/**
 * Used to check the admin cal functionality access
 */
function admincalendar_user_access($roles){
	if (user_is_logged_in()) {
		global $user;
		$adminCalendarPerm = array(
								'Catalog Course Admin Perm',  		// courses
								'Resources Admin Perm', 			// locations
								'Announcement Admin Perm', 			// announcements
								'Report visibility Perm', 			// reports
								'view all orders',	 				// orders
								'Forum Perm',						// forum,
								'Users Admin Perm'					// users to access instructors
							);
		foreach ($adminCalendarPerm as $role) {
			if (user_access($role)) {
				return TRUE;
				break;
			}
		}
	}
	else {
		return FALSE;
	}
}


function exp_sp_admincalendar_page_callback() {
	global $theme_key;
	$css_module_optional = array('type' => 'file', 'group' => CSS_DEFAULT);
	/*$css_theme_optional = array('type' => 'file', 'group' => CSS_THEME);
	$header_optional = array('type' => 'file', 'scope' => 'header', 'group' => JS_LIBRARY);
	$js_module_optional = array('type' => 'file', 'group' => JS_DEFAULT);
	*/
     
    // support includes for module functionality
	include_once(drupal_get_path('module', 'exp_sp_learning') .'/exp_sp_learning.inc');
    include_once(drupal_get_path('module', 'exp_sp_administration_catalog') .'/exp_sp_administration_catalog_class.inc');
    include_once(drupal_get_path('module', 'exp_sp_administration_catalog') .'/exp_sp_administration_catalog_course.inc');//51329
    include_once(drupal_get_path('module', 'exp_sp_administration_learning') .'/exp_sp_administration_attachment.inc');
    include_once(drupal_get_path('module', 'exp_sp_administration_learning') .'/exp_sp_administration_session_details.inc');
    include_once(drupal_get_path('module', 'exp_sp_administration_learning') .'/exp_sp_administration_content_details.inc');
    include_once(drupal_get_path('module', 'exp_sp_administration_learning') .'/exp_sp_administration_class_register.inc');
    include_once(drupal_get_path('module', 'exp_sp_administration_catalog') .'/exp_sp_administration_catalog_roster.inc');
	
    drupal_add_css(drupal_get_path('module', 'exp_sp_administration_catalog') .'/exp_sp_administration_catalog_roster_v2.css', $css_theme_optional);
   	drupal_add_css(drupal_get_path('module', 'exp_sp_administration_catalog') .'/exp_sp_administration_catalog_v2.css', $css_theme_optional);
   //	drupal_add_css(drupal_get_path('module', 'exp_sp_administration_learning') .'/exp_sp_administration_data_grid_v2.css', $css_theme_optional);
    includeJqGridJsCss();
	drupal_add_css(drupal_get_path('module', 'exp_sp_classdetail').'/exp_sp_classdetail_v2.css', $css_module_optional);
	drupal_add_css(drupal_get_path('module', 'exp_sp_prerequisite') .'/exp_sp_prerequisite_v2.css', $css_theme_optional);
    // drupal_add_css(drupal_get_path('module', 'exp_sp_administration') .'/exp_sp_administration_announcement_v2.css', $css_theme_optional);


    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.expertus.datatable.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.soapclient.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.fileupload.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.showHelpPage.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.expertus.cluetip.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_search/exp_sp_searchwidget.js');
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/lib/sarissa.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.tabs.scroll.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.table2CSV.js',$js_module_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.expertus.datatable_roster.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.dataTablesReport.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.expertus.calendar.js',$header_optional);
    
    // drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/swfobject.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.pagelayout.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.colorpicker.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.tree.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/plugins/jquery.tree.xml_flat.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/plugins/jquery.tree.checkbox.js',$header_optional);
    //drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_tree/exp_sp_treewidget.js',$js_module_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/exp_multiselect/jquery.expertus.multiselect.js',$js_module_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/exp_multiselect/jquery.expertus.multiselectDropdown.js',$js_module_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/exp_multiselect/jquery.expertus.multiselectExtend.js',$js_module_optional);
    
    // json2.js is requied for IE
    // TODO: json2.js should load if the browser is IE for rest of the browsers it should not be loaded.
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/exp_multiselect/json2.js',$js_module_optional);
    drupal_add_css(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/exp_multiselect/css/jquery.expertus.multiselect.css',$css_theme_optional);
 	drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/jscrollbar/jquery.mousewheel.js', $js_module_optional);
	drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/jscrollbar/jquery.jscrollpane.js', $js_module_optional);
	drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/colorpicker/jquery.colorPicker.js', $js_module_optional);
    drupal_add_css(drupal_get_path('module', 'exp_sp_lnrreports') .'/colorpicker/colorPicker.css');
      
    //CUSTOM SCROLLBAR "JSscrollbar" 
    drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/jscrollbar/jquery.jscrollpane.js', $js_module_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/jscrollbar/jquery.mousewheel.js', $js_module_optional);
    
    drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/exp_sp_lnrreports.js', $js_module_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/exp_sp_lnrreports_schedules.js', $js_module_optional);
      
    $adminAccess  = reportAdminAccess();
      
    //drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/exp_sp_lnrreports_search_wz_jsgraphics.js');
    drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/dragdrop/jquery.jsPlumb-1.3.16-all.js');
    drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/exp_sp_lnrreports_search.js');
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jquery.expertus.calendar.js',$header_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_lnrcalendar') .'/exp_sp_lnrcalendar.js', $js_module_optional);
    drupal_add_css('misc/ui/jquery.ui.datepicker.css');
    // drupal_add_css(drupal_get_path('module', 'exp_sp_administration') .'/exp_sp_administration_view_v2.css', $css_theme_optional);
  	//NEWUI THEME STYLE SHEET
  	drupal_add_css(drupal_get_path('module', 'exp_sp_lnrreports') .'/exp_sp_lnrreports_search_v2.css');
  	// drupal_add_css(drupal_get_path('module', 'exp_sp_administration') .'/exp_sp_administration_v2.css', array('group' => CSS_THEME, 'browsers' => array('IE' => 'gte IE 7'), 'preprocess' => FALSE));
  //	drupal_add_css(drupal_get_path('module', 'exp_sp_administration_learning') .'/exp_sp_administration_data_grid_v2.css', $css_theme_optional);
  	drupal_add_css(drupal_get_path('module', 'exp_sp_core').'/css/calender_style_v2.css',$css_module_optional);
  	/* 	drupal_add_css(drupal_get_path('module', 'exp_sp_administration_learning') .'/exp_sp_administration_learning_v2.css', $css_theme_optional); */
	if(module_exists('exp_sp_esignature')){
		if($theme_key == 'expertusoneV2') {
	  		drupal_add_css(drupal_get_path('module', 'exp_sp_esignature') .'/exp_sp_esignature_v2.css', array('type' => 'file', 'group' => CSS_DEFAULT));
	  		}else{
	  			drupal_add_css(drupal_get_path('module', 'exp_sp_esignature') .'/exp_sp_esignature.css', array('type' => 'file', 'group' => CSS_DEFAULT));
	  		}
	}
	  	
    // Multiselect
    $js_module_optional = array('type' => 'file', 'group' => JS_DEFAULT);
    drupal_add_css(drupal_get_path('module', 'exp_sp_lnrreports') .'/dragdrop/jsPlumb.css');
    // drupal_add_css(drupal_get_path('module', 'exp_sp_administration_user') .'/jquery.multiselect.css');
    // drupal_add_css(drupal_get_path('module', 'exp_sp_administration_user') .'/jquery.multiselect.filter.css');
    drupal_add_js(drupal_get_path('module', 'exp_sp_administration_user') .'/jquery.multiselect.filter.js', $js_module_optional);
    drupal_add_js(drupal_get_path('module', 'exp_sp_administration_user') .'/jquery.multiselect.js', $js_module_optional);
                
    drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/exp_sp_jquery/jqgrid_latest/js/grid.jqueryui.js', array('type' => 'file', 'scope' => 'header', 'group' => JS_LIBRARY, 'weight' => 5));
	drupal_add_js(drupal_get_path('module', 'exp_sp_administration_learning') .'/exp_sp_administration_data_grid.js', $js_module_optional);
    drupal_add_css(drupal_get_path('module', 'exp_sp_lnrreports') .'/exp_sp_lnrreports_v2.css', array('type' => 'file', 'group' => CSS_THEME, 'weight'=>1300));
    // drupal_add_css(drupal_get_path('module', 'exp_sp_administration_learning') .'/exp_sp_administration_data_grid_v2.css', $css_theme_optional);
    drupal_add_css(drupal_get_path('module', 'exp_sp_lnrcalendar') .'/exp_sp_lnrcalendar_v2.css', $css_theme_optional);
      
    //JQUERY SCROLL BAR 
    drupal_add_js(drupal_get_path('module', 'exp_sp_lnrreports') .'/dragdrop/jquery.jscrollpane.js', $js_module_optional);
      
    // drupal_add_css("/sites/all/themes/core/expertusoneV2/expertusone-internals/css/layout-fixed.css",$css_theme_optional);
   // drupal_add_css("/misc/ui/jquery.ui.theme.css",$css_theme_optional);//63042 does not load ui properly in ie browsers
    drupal_add_js(drupal_get_path('module', 'exp_sp_administration') .'/exp_sp_administration_addedit_behaviours.js', $js_module_optional);

	$metadata = array();
	$row = new stdClass();
	$row->todaydate = date("Y-m-d H:i");
	$metadata[] = $row;
	
	
	$perm_list = getAdminCalendarSettings('list');
	$config=getConfig('exp_sp');
	$admin_calendar_search_max_time = (!empty($config['admin_calendar_search_max_time'])) ? ($config['admin_calendar_search_max_time']*1000) : 29000;
	drupal_add_js(array('cal' => array('plist' =>  $perm_list,'admin_calendar_search_max_time'=>$admin_calendar_search_max_time)), 'setting');
	$userCalPref = getAdminCalendarPreference();
	expDebug::dPrint("preference data calback:" . var_export($userCalPref, 1), 4);
	setcookie("admincalendar_pref", json_encode($userCalPref));
	if (preg_match('/MSIE/',$_SERVER['HTTP_USER_AGENT'])) { // 0062494 - load div added in IE browsers
		$loaderContent = '<div id="loader-container"><div width="942" height="75"><table width="100%" border="0"><tbody><tr><td width="942" valign="middle" height="75" align="center"><div class="loaderimg" style="margin-top: -2.5px;"></div></td></tr></tbody></table></div></div>';
	} else {
		$loaderContent = '';
	}
	
	return "<script>var calendarmetadata=".drupal_json_encode($metadata)."</script><div id='calendar'>".$loaderContent."<div class='admincalendarviewmorepopupdiv'></div><div id=\"show_expertus_message\"></div><div class='createnewpopupdiv'></div><div class='viewreportorderpopupdiv'></div><div id='root-admin'></div><div id='lnr-reports-search'></div><div  class='calendar-left-column'><div id='calendarnarrowview'></div></div><div id='calendarprimaryview'></div><div id='calendarlegendview' class='calendarlegendview' style='display:none;'><ul><li><span class='legend-ilt-cls'></span><label class='text-ilt-cls'>".t('Classroom')."</label></li><li><span class='legend-vcl-cls'></span><label class='text-vcl-cls'>".t('Virtual Class')."</label></li><li><span class='legend-reg-end'></span><label class='text-reg-end'>".t('LBL565')."</label></li><li><span class='legend-announcement'></span><label class='text-announcement'>".t('LBL196')."</label></li><li><span class='legend-order'></span><label class='text-order'>".t('Orders')."</label></li><li><span class='legend-report'></span><label class='text-report'>".t('Scheduled')." ".t('Report')."</label></li></ul></div></div><script>var calendardata = ".exp_sp_admincalendar_contents()."</script>";
}

/**
 * Implements hook_block_info().
 */
function exp_sp_admincalendar_block_info() {
  $blocks['exp_sp_admincalendar'] = array(
    // The name that will appear in the block list.
    'info' => t('Admin Calendar'),
    // Default setting.
    'cache' => DRUPAL_CACHE_PER_ROLE,
  );
  return $blocks;
}

function exp_sp_admincalendar_block_view($delta = '') 
{
  switch ($delta) 
  {
    case 'exp_sp_admincalendar':
   	   $block['subject'] = t('Admin Calendar');
       if (user_access('access content')) 
       {
			$block['content'] = "";
   		}
    return $block;
  	}
 }
   

function exp_sp_admincalendar_contents(){

	return "{}";
  //include_once $_SERVER["DOCUMENT_ROOT"]."/sites/all/modules/core/exp_sp_core/modules/exp_sp_administration/exp_sp_administration_learning/exp_sp_administration_catalog/exp_sp_administration_catalog.inc";
	//include_once $_SERVER["DOCUMENT_ROOT"]."/sites/all/modules/core/exp_sp_core/modules/exp_sp_administration/exp_sp_admincalendar/exp_sp_admincalendar.inc";
  	//$data = getCalendarViewData();
  	//return $data;
}

/**
 * Used to retrive logged user permission list
 */

function getAdminCalendarSettings($format = 'json') {
	global $user;
	
	/*if(user_is_logged_in() ==  0){
		print "session_out";
		exit;
	}*/

	$permission_lists = array(
		'view_announcements' => 'Announcement Admin Perm',
		'view_classroom' => 'Catalog Course Admin Perm',
		'view_virtualclassroom' => 'Catalog Course Admin Perm',
		'view_discussions' => 'Forum Perm',
		//'view_events' => 'Catalog Course Admin Perm',
		'view_instructors' => 'Users Admin Perm',
		'view_locations' => 'Resources Admin Perm',
		'view_orders' => 'view all orders',
		'view_scheduled_report' => 'Report visibility Perm',
		'create_report' => 'Create Report Perm'	
	) ;

	foreach($permission_lists as $key => $value) {
		if (user_access($permission_lists[$key]) || $user->uid == 1 ) { // allow all privilge enabled for super admin
			$permission_lists[$key] = 'enabled';
		} else {
			$permission_lists[$key] = 'disabled';
		}
	}
	
	// Build create permission list
	$create_permissions = array(
			'create_class' => 'cre_sys_obt_crs',
			'create_announcement' => 'cre_sys_obt_not',
	);
	
	foreach($create_permissions as $key => $value) {
		$createAccess = adminVisibilityForGlobalAdd($value, '', 'admin_calendar');
		if ($createAccess[0]->addvisible || $user->uid == 1) { // allow all privilge enabled for super admin
			$permission_lists[$key] = 'enabled';
		} else {
			$permission_lists[$key] = 'disabled';
		}
	}
	$permission_lists['commerce'] = module_exists('exp_sp_commerce');
	$permission_lists['forum'] = module_exists('exp_sp_forum');
	//expDebug::dPrint("forum module " .module_exists('exp_sp_forum'));
	if ($format == 'list') 
		return $permission_lists;
	else 
		drupal_json_output($permission_lists);	
}

function getAdminCalendarPreference($sltPersonId= '') {
	try {
		$sltPersonId = getSltpersonUserId();	
		//Calling the function for #0071413 by vetrivel.P
		$Pref = getAdminCalendarSettings('list');
		$select	= db_select('slt_admincalendar_preference', 'cal');
		$select->addField('cal', 'view_preference', 'view_preference');
		$select->condition('user_id', $sltPersonId);
		$result = $select->execute()->fetchColumn();
		if (!empty($result)) {
			$user_preference = unserialize($result);
		} else {
			$default_preference = new stdClass();
			$default_preference->view_classroom = true;
			$default_preference->view_virtualclassroom = true;
			$default_preference->view_announcements = true;
			$default_preference->view_orders = true;
			$default_preference->view_scheduled_report = true;
			$default_preference->view_locations = true;
			$default_preference->view_discussions = true;
			$default_preference->view_instructors = true;
			//$default_preference->view_events = true;
			
			//Added for #0071413 by vetrivel.P
			if($Pref['view_announcements'] == 'disabled')$default_preference->view_announcements = false;
			if($Pref['view_classroom'] == 'disabled')$default_preference->view_classroom = false;
			if($Pref['view_virtualclassroom'] == 'disabled')$default_preference->view_virtualclassroom = false;
			if($Pref['view_discussions'] == 'disabled')$default_preference->view_discussions = false;
			//if($Pref['view_events'] == 'disabled')$default_preference->view_events = false;
			if($Pref['view_instructors'] == 'disabled')$default_preference->view_instructors = false;
			if($Pref['view_locations'] == 'disabled')$default_preference->view_locations = false;
			if($Pref['view_orders'] == 'disabled')$default_preference->view_orders = false;
			if($Pref['view_scheduled_report'] == 'disabled')$default_preference->view_scheduled_report = false;
			
			$user_preference = $default_preference;
		}
		expDebug::dPrint("getAdminCalendarPreference stored::" . print_r($user_preference, 1));
		return $user_preference;
	} catch(Exception $ex) {
		watchdog_exception('getAdminCalendarPreference', $ex);
		expertusErrorThrow($ex);
	}
}

function setAdminCalendarPreference($sltPersonId= '') {
	try {
		expDebug::dPrint("setAdminCalendarPreference indside");
		$sltPersonId 		= getSltpersonUserId();
		$user_preference 	= $_COOKIE['admincalendar_pref'];
		if (!empty($user_preference)) {
			$user_preference = json_decode($user_preference);
			array_walk($user_preference, 'convertToBoolean');
			expDebug::dPrint("setAdminCalendarPreference indside obj" . var_export($user_preference, 1));
			$user_preference = serialize($user_preference);
			$updateStmt = db_merge('slt_admincalendar_preference')
			->insertFields(array(
			    'user_id' => $sltPersonId,
			    'view_preference' => $user_preference,
				'created_on' => date('Y-m-d H:i:s'),
				'created_by' => $sltPersonId,
				'updated_on' => date('Y-m-d H:i:s'),
				'updated_by' => $sltPersonId,
			))
			->updateFields(array(
				'view_preference' => $user_preference,
			   	'updated_on' => date('Y-m-d H:i:s'),
				'updated_by' => $sltPersonId,
			))
			->key(array('user_id' => $sltPersonId))
			->execute();
			echo true;
		}
		echo false;
		drupal_exit();
	} catch(Exception $ex) {
		watchdog_exception('getAdminCalendarPreference', $ex);
		expertusErrorThrow($ex);
	}
}

function convertToBoolean(&$item, $key) {
	$item = (bool) $item;
}
?>