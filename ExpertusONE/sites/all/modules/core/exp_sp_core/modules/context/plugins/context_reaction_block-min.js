(function(a){Drupal.behaviors.contextReactionBlock={attach:function(b){a("form.context-editor:not(.context-block-processed)").addClass("context-block-processed").each(function(){var c=a(this).attr("id");Drupal.contextBlockEditor=Drupal.contextBlockEditor||{};a(this).bind("init.pageEditor",function(d){Drupal.contextBlockEditor[c]=new DrupalContextBlockEditor(a(this));});a(this).bind("start.pageEditor",function(e,d){if(!d){d=a(this).data("defaultContext");}Drupal.contextBlockEditor[c].editStart(a(this),d);});a(this).bind("end.pageEditor",function(d){Drupal.contextBlockEditor[c].editFinish();});});a("#context-blockform:not(.processed)").each(function(){a(this).addClass("processed");Drupal.contextBlockForm=new DrupalContextBlockForm(a(this));Drupal.contextBlockForm.setState();});a("#context-blockform a.remove:not(.processed)").each(function(){a(this).addClass("processed");a(this).click(function(){a(this).parents("tr").eq(0).remove();Drupal.contextBlockForm.setState();return false;});});a("div.context-block-browser",b).nextAll(".form-item").hide();
}};DrupalContextBlockForm=function(b){this.state={};this.setState=function(){a("table.context-blockform-region",b).each(function(){var c=a(this).attr("id").split("context-blockform-region-")[1];var d=[];a("tr",a(this)).each(function(){var e=a(this).attr("id");var f=a(this).find("select,input").first().val();d.push({bid:e,weight:f});});Drupal.contextBlockForm.state[c]=d;});a("form input.context-blockform-state").val(JSON.stringify(this.state));a("table.context-blockform-region tr").each(function(){var c=a(this).attr("id");a("div.context-blockform-selector input[value="+c+"]").parents("div.form-item").eq(0).hide();});a("div.context-blockform-selector input").each(function(){var c=a(this).val();if(a("table.context-blockform-region tr#"+c).size()===0){a(this).parents("div.form-item").eq(0).show();}});};a("#ctools-export-ui-edit-item-form").submit(function(){Drupal.contextBlockForm.setState();});a.each(Drupal.settings.tableDrag,function(d){var c=a("#"+d+":not(.processed)",b);if(c&&c.is(".context-blockform-region")){c.addClass("processed");
c.bind("mouseup",function(e){Drupal.contextBlockForm.setState();return;});}});a("td.blocks a",b).each(function(){a(this).click(function(){var h=a(this).attr("href").split("#")[1];var g="context-blockform-region-"+h;var f=a("div.context-blockform-selector input:checked");if(f.size()>0){var e=false;var c=-10;var i=10;var d=c-1;a("table#"+g+" tr").each(function(){var j=a(this).find("select,input").first().val();if(+j>+d){d=j;}});f.each(function(){var n=document.createElement("tr");var m=a(this).parents("div.form-item").eq(0).hide().children("label").text();var j='<div class="form-item form-type-select"><select class="tabledrag-hide form-select">';var k;e=true;var l=i;if(i>=(1+ +d)){l=++d;e=false;}for(k=c;k<=i;++k){j+="<option";if(k==l){j+=" selected=selected";}j+=">"+k+"</option>";}j+="</select></div>";a(n).attr("id",a(this).attr("value")).addClass("draggable");a(n).html("<td>"+m+"</td><td>"+j+"</td><td><a href='' class='remove'>X</a></td>");Drupal.tableDrag[g].makeDraggable(n);a("table#"+g).append(n);
if(a.cookie("Drupal.tableDrag.showWeight")==1){a("table#"+g).find(".tabledrag-hide").css("display","");a("table#"+g).find(".tabledrag-handle").css("display","none");}else{a("table#"+g).find(".tabledrag-hide").css("display","none");a("table#"+g).find(".tabledrag-handle").css("display","");}Drupal.attachBehaviors(a("table#"+g));Drupal.contextBlockForm.setState();a(this).removeAttr("checked");});if(e){alert(Drupal.t("Desired block weight exceeds available weight options, please check weights for blocks before saving"));}}return false;});});};DrupalContextBlockEditor=function(b){this.editor=b;this.state={};this.blocks={};this.regions={};return this;};DrupalContextBlockEditor.prototype={initBlocks:function(c){var b=this;this.blocks=c;c.each(function(){if(a(this).hasClass("context-block-empty")){a(this).removeClass("context-block-hidden");}a(this).addClass("draggable");a(this).prepend(a('<a class="context-block-handle"></a>'));a(this).prepend(a('<a class="context-block-remove"></a>').click(function(){a(this).parent(".block").eq(0).fadeOut("medium",function(){a(this).remove();
b.updateBlocks();});return false;}));});},initRegions:function(c){this.regions=c;var b=this;a(c).not(".context-ui-processed").each(function(d,e){a(".context-ui-add-link",e).click(function(f){b.showBlockBrowser(a(this).parent());}).addClass("context-ui-processed");});a(".context-block-browser").hide();},showBlockBrowser:function(g){var h=false;var c=a(".context-editing",this.editor).attr("id").replace("-trigger",""),d=a("#"+c)[0];this.browser=a(".context-block-browser",d).addClass("active");if(!this.browser.has("input.filter").size()){var e=a(".block-browser-sidebar .filter",this.browser);var f=a(".blocks",this.browser);new Drupal.Filter(f,false,".context-block-addable",e);}this.browser.show().dialog({modal:true,close:function(){a(this).dialog("destroy");a(".category",this).show();a(this).hide().appendTo(d).removeClass("active");},height:(0.8*a(window).height()),minHeight:400,minWidth:680,width:680});a(".context-block-browser-categories",this.browser).change(function(i){if(a(this).val()==0){a(".category",b.browser).show();
}else{a(".category",b.browser).hide();a(".category-"+a(this).val(),b.browser).show();}});if(this.addToRegion){a(".context-block-addable",this.browser).unbind("click.addToRegion");}var b=this;this.addToRegion=function(j){var i={item:a(this).clone(),sender:a(g)};a(this).parents(".context-block-browser.active").dialog("close");a(g).after(i.item);b.addBlock(j,i,this.editor,c.replace("context-editable-",""));};a(".context-block-addable",this.browser).bind("click.addToRegion",this.addToRegion);},updateBlocks:function(){var b=a("div.context-block-browser");a(".block, .admin-block").each(function(){var c=a(this).attr("id").split("block-")[1];});a(".context-block-item",b).each(function(){var c=a(this).attr("id").split("context-block-addable-")[1];});a(this.regions).each(function(){if(a(".block:has(a.context-block)",this).size()>0){a(this).removeClass("context-block-region-empty");}else{a(this).addClass("context-block-region-empty");}});},updateRegion:function(b,c,d,e){switch(e){case"over":a(d).removeClass("context-block-region-empty");
break;case"out":if(a(".draggable-placeholder",d).size()===1&&a(".block:has(a.context-block)",d).size()==0){a(d).addClass("context-block-region-empty");}break;}},scriptFix:function(e,f,d,c){if(a("script",f.item)){var g=a(Drupal.settings.contextBlockEditor.scriptPlaceholder);var b=a("div.handle label",f.item).text();g.children("strong").html(b);a("script",f.item).parent().empty().append(g);}},addBlock:function(g,h,f,e){var b=this;if(h.item.is(".context-block-addable")){var c=h.item.attr("id").split("context-block-addable-")[1];var i=Drupal.settings.contextBlockEditor.params;i.context_block=c+","+e;if(!Drupal.settings.contextBlockEditor.block_tokens||!Drupal.settings.contextBlockEditor.block_tokens[c]){alert(Drupal.t("An error occurred trying to retrieve block content. Please contact a site administer."));return;}i.context_token=Drupal.settings.contextBlockEditor.block_tokens[c];var d=a('<div class="context-block-item context-block-loading"><span class="icon"></span></div>');h.item.addClass("context-block-added");
h.item.after(d);a.getJSON(Drupal.settings.contextBlockEditor.path,i,function(j){if(j.status){var k=a(j.block);if(a("script",k)){a("script",k).remove();}d.fadeOut(function(){a(this).replaceWith(k);b.initBlocks(k);b.updateBlocks();Drupal.attachBehaviors(k);});}else{d.fadeOut(function(){a(this).remove();});}});}else{if(h.item.is(":has(a.context-block)")){b.updateBlocks();}}},setState:function(){var b=this;a(this.regions).each(function(){var c=a(".context-block-region",this).attr("id").split("context-block-region-")[1];var d=[];a("a.context-block",a(this)).each(function(){if(a(this).attr("class").indexOf("edit-")!=-1){var e=a(this).attr("id").split("context-block-")[1];var f=a(this).attr("class").split("edit-")[1].split(" ")[0];f=f?f:0;var g={bid:e,context:f};d.push(g);}});b.state[c]=d;});a("input.context-block-editor-state",this.editor).val(JSON.stringify(this.state));},disableTextSelect:function(){if(a.browser.safari){a(".block:has(a.context-block):not(:has(input,textarea))").css("WebkitUserSelect","none");
}else{if(a.browser.mozilla){a(".block:has(a.context-block):not(:has(input,textarea))").css("MozUserSelect","none");}else{if(a.browser.msie){a(".block:has(a.context-block):not(:has(input,textarea))").bind("selectstart.contextBlockEditor",function(){return false;});}else{a(this).bind("mousedown.contextBlockEditor",function(){return false;});}}}},enableTextSelect:function(){if(a.browser.safari){a("*").css("WebkitUserSelect","");}else{if(a.browser.mozilla){a("*").css("MozUserSelect","");}else{if(a.browser.msie){a("*").unbind("selectstart.contextBlockEditor");}else{a(this).unbind("mousedown.contextBlockEditor");}}}},editStart:function(e,d){var b=this;a(document.body).addClass("context-editing");this.editor.addClass("context-editing");this.disableTextSelect();this.initBlocks(a(".block:has(a.context-block.edit-"+d+")"));this.initRegions(a(".context-block-region").parent());this.updateBlocks();a("a.context_ui_dialog-stop").hide();a(".editing-context-label").remove();var c=a("#context-editable-trigger-"+d+" .label").text();
c=Drupal.t("Now Editing: ")+c;e.parent().parent().prepend('<div class="editing-context-label">'+c+"</div>");a(this.regions).each(function(){var f=a(this);var g={revert:true,dropOnEmpty:true,placeholder:"draggable-placeholder",forcePlaceholderSize:true,items:"> .block:has(a.context-block.editable)",handle:"a.context-block-handle",start:function(h,i){b.scriptFix(h,i,e,d);},stop:function(h,i){b.addBlock(h,i,e,d);},receive:function(h,i){b.addBlock(h,i,e,d);},over:function(h,i){b.updateRegion(h,i,f,"over");},out:function(h,i){b.updateRegion(h,i,f,"out");},cursorAt:{left:300,top:0}};f.sortable(g);});a(this.regions).each(function(){a(this).sortable("option","connectWith",[".ui-sortable"]);});if(a.ui.version==="1.6"&&a.browser.safari){a.browser.mozilla=true;}},editFinish:function(){this.editor.removeClass("context-editing");this.enableTextSelect();a(".editing-context-label").remove();a(this.blocks).each(function(){a("a.context-block-handle, a.context-block-remove",this).remove();if(a(this).hasClass("context-block-empty")){a(this).addClass("context-block-hidden");
}a(this).removeClass("draggable");});a("a.context_ui_dialog-stop").show();this.regions.sortable("destroy");this.setState();if(a.ui.version==="1.6"&&a.browser.safari){a.browser.mozilla=false;}}};})(jQuery);