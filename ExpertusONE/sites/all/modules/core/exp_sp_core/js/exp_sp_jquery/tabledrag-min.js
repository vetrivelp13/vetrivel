Drupal.behaviors.tableDrag=function(b){for(var c in Drupal.settings.tableDrag){if(!$("#"+c+".tabledrag-processed",b).size()){var a=Drupal.settings.tableDrag[c];$("#"+c).filter(":not(.tabledrag-processed)").each(function(){Drupal.tableDrag[c]=new Drupal.tableDrag(this,a);});$("#"+c).addClass("tabledrag-processed");}}};Drupal.tableDrag=function(d,c){var b=this;this.table=d;this.tableSettings=c;this.dragObject=null;this.rowObject=null;this.oldRowElement=null;this.oldY=0;this.changed=false;this.maxDepth=0;this.rtl=$(this.table).css("direction")=="rtl"?-1:1;this.scrollSettings={amount:4,interval:50,trigger:70};this.scrollInterval=null;this.scrollY=0;this.windowHeight=0;this.indentEnabled=false;for(group in c){for(n in c[group]){if(c[group][n]["relationship"]=="parent"){this.indentEnabled=true;}if(c[group][n]["limit"]>0){this.maxDepth=c[group][n]["limit"];}}}if(this.indentEnabled){this.indentCount=1;var a=Drupal.theme("tableDragIndentation");var e=$("tr.draggable:first td:first",d).prepend(a).prepend(a);
this.indentAmount=$(".indentation",e).get(1).offsetLeft-$(".indentation",e).get(0).offsetLeft;$(".indentation",e).slice(0,2).remove();}$("tr.draggable",d).each(function(){b.makeDraggable(this);});this.hideColumns();$(document).bind("mousemove",function(f){return b.dragRow(f,b);});$(document).bind("mouseup",function(f){return b.dropRow(f,b);});};Drupal.tableDrag.prototype.hideColumns=function(){for(var g in this.tableSettings){for(var h in this.tableSettings[g]){var f=$("."+this.tableSettings[g][h]["target"]+":first",this.table);if(f.size()&&this.tableSettings[g][h]["hidden"]){var e=this.tableSettings[g][h]["hidden"];var a=f.parents("td:first");break;}}if(e&&a[0]&&a.css("display")!="none"){var c=$("td",a.parent()).index(a.get(0))+1;var b=$("td:not(:hidden)",a.parent()).index(a.get(0))+1;$("tr",this.table).each(function(){var i=$(this);var j=i.parent().get(0).tagName.toLowerCase();var d=(j=="thead")?b:c;i.children().each(function(k){if(k<d){d-=(this.colSpan&&this.colSpan>1)?this.colSpan-1:0;
}});if(d>0){a=i.children(":nth-child("+d+")");if(a[0].colSpan>1){a[0].colSpan=a[0].colSpan-1;}else{j=="thead"?a.remove():a.css("display","none");}}});}}};Drupal.tableDrag.prototype.rowSettings=function(c,e){var b=$("."+c,e);for(delta in this.tableSettings[c]){var a=this.tableSettings[c][delta]["target"];if(b.is("."+a)){var d=new Object();for(var f in this.tableSettings[c][delta]){d[f]=this.tableSettings[c][delta][f];}return d;}}};Drupal.tableDrag.prototype.makeDraggable=function(b){var a=this;var c=$('<a href="#" class="tabledrag-handle"><div class="handle">&nbsp;</div></a>').attr("title",Drupal.t("Drag to re-order"));if($("td:first .indentation:last",b).after(c).size()){a.indentCount=Math.max($(".indentation",b).size(),a.indentCount);}else{$("td:first",b).prepend(c);}c.hover(function(){a.dragObject==null?$(this).addClass("tabledrag-handle-hover"):null;},function(){a.dragObject==null?$(this).removeClass("tabledrag-handle-hover"):null;});c.mousedown(function(d){a.dragObject=new Object();
a.dragObject.initMouseOffset=a.getMouseOffset(b,d);a.dragObject.initMouseCoords=a.mouseCoords(d);if(a.indentEnabled){a.dragObject.indentMousePos=a.dragObject.initMouseCoords;}if(a.rowObject){$("a.tabledrag-handle",a.rowObject.element).blur();}a.rowObject=new a.row(b,"mouse",a.indentEnabled,a.maxDepth,true);a.table.topY=$(a.table).offset().top;a.table.bottomY=a.table.topY+a.table.offsetHeight;$(this).addClass("tabledrag-handle-hover");$(b).addClass("drag");$("body").addClass("drag");if(a.oldRowElement){$(a.oldRowElement).removeClass("drag-previous");}if(navigator.userAgent.indexOf("MSIE 6.")!=-1){$("select",this.table).css("display","none");}a.safeBlur=false;a.onDrag();return false;});c.click(function(){return false;});c.focus(function(){$(this).addClass("tabledrag-handle-hover");a.safeBlur=true;});c.blur(function(d){$(this).removeClass("tabledrag-handle-hover");if(a.rowObject&&a.safeBlur){a.dropRow(d,a);}});c.keydown(function(g){if(g.keyCode!=9&&!a.rowObject){a.rowObject=new a.row(b,"keyboard",a.indentEnabled,a.maxDepth,true);
}var h=false;switch(g.keyCode){case 37:case 63234:h=true;a.rowObject.indent(-1*a.rtl);break;case 38:case 63232:var d=$(a.rowObject.element).prev("tr").get(0);while(d&&$(d).is(":hidden")){d=$(d).prev("tr").get(0);}if(d){a.safeBlur=false;a.rowObject.direction="up";h=true;if($(b).is(".tabledrag-root")){var e=0;while(d&&$(".indentation",d).size()){d=$(d).prev("tr").get(0);e+=$(d).is(":hidden")?0:d.offsetHeight;}if(d){a.rowObject.swap("before",d);window.scrollBy(0,-e);}}else{if(a.table.tBodies[0].rows[0]!=d||$(d).is(".draggable")){a.rowObject.swap("before",d);a.rowObject.interval=null;a.rowObject.indent(0);window.scrollBy(0,-parseInt(b.offsetHeight));}}c.get(0).focus();}break;case 39:case 63235:h=true;a.rowObject.indent(1*a.rtl);break;case 40:case 63233:var f=$(a.rowObject.group).filter(":last").next("tr").get(0);while(f&&$(f).is(":hidden")){f=$(f).next("tr").get(0);}if(f){a.safeBlur=false;a.rowObject.direction="down";h=true;if($(b).is(".tabledrag-root")){var e=0;nextGroup=new a.row(f,"keyboard",a.indentEnabled,a.maxDepth,false);
if(nextGroup){$(nextGroup.group).each(function(){e+=$(this).is(":hidden")?0:this.offsetHeight;});nextGroupRow=$(nextGroup.group).filter(":last").get(0);a.rowObject.swap("after",nextGroupRow);window.scrollBy(0,parseInt(e));}}else{a.rowObject.swap("after",f);a.rowObject.interval=null;a.rowObject.indent(0);window.scrollBy(0,parseInt(b.offsetHeight));}c.get(0).focus();}break;}if(a.rowObject&&a.rowObject.changed==true){$(b).addClass("drag");if(a.oldRowElement){$(a.oldRowElement).removeClass("drag-previous");}a.oldRowElement=b;a.restripeTable();a.onDrag();}if(h){return false;}});c.keypress(function(d){switch(d.keyCode){case 37:case 38:case 39:case 40:return false;}});};Drupal.tableDrag.prototype.dragRow=function(b,i){if(i.dragObject){i.currentMouseCoords=i.mouseCoords(b);var e=i.currentMouseCoords.y-i.dragObject.initMouseOffset.y;var g=i.currentMouseCoords.x-i.dragObject.initMouseOffset.x;if(e!=i.oldY){i.rowObject.direction=e>i.oldY?"down":"up";i.oldY=e;var d=i.checkScroll(i.currentMouseCoords.y);
clearInterval(i.scrollInterval);if(d>0&&i.rowObject.direction=="down"||d<0&&i.rowObject.direction=="up"){i.setScroll(d);}var h=i.findDropTargetRow(g,e);if(h){if(i.rowObject.direction=="down"){i.rowObject.swap("after",h,i);}else{i.rowObject.swap("before",h,i);}i.restripeTable();}}if(i.indentEnabled){var f=i.currentMouseCoords.x-i.dragObject.indentMousePos.x;var c=Math.round(f/i.indentAmount*i.rtl);var a=i.rowObject.indent(c);i.dragObject.indentMousePos.x+=i.indentAmount*a*i.rtl;i.indentCount=Math.max(i.indentCount,i.rowObject.indents);}return false;}};Drupal.tableDrag.prototype.dropRow=function(c,a){if(a.rowObject!=null){var b=a.rowObject.element;if(a.rowObject.changed==true){a.updateFields(b);for(var d in a.tableSettings){var e=a.rowSettings(d,b);if(e.relationship=="group"){for(n in a.rowObject.children){a.updateField(a.rowObject.children[n],d);}}}a.rowObject.markChanged();if(a.changed==false){$(Drupal.theme("tableDragChangedWarning")).insertAfter(a.table).hide().fadeIn("slow");a.changed=true;
}}if(a.indentEnabled){a.rowObject.removeIndentClasses();}if(a.oldRowElement){$(a.oldRowElement).removeClass("drag-previous");}$(b).removeClass("drag").addClass("drag-previous");a.oldRowElement=b;a.onDrop();a.rowObject=null;}if(a.dragObject!=null){$(".tabledrag-handle",b).removeClass("tabledrag-handle-hover");a.dragObject=null;$("body").removeClass("drag");clearInterval(a.scrollInterval);if(navigator.userAgent.indexOf("MSIE 6.")!=-1){$("select",this.table).css("display","block");}}};Drupal.tableDrag.prototype.mouseCoords=function(a){if(a.pageX||a.pageY){return{x:a.pageX,y:a.pageY};}return{x:a.clientX+document.body.scrollLeft-document.body.clientLeft,y:a.clientY+document.body.scrollTop-document.body.clientTop};};Drupal.tableDrag.prototype.getMouseOffset=function(d,c){var b=$(d).offset();var a=this.mouseCoords(c);return{x:a.x-b.left,y:a.y-b.top};};Drupal.tableDrag.prototype.findDropTargetRow=function(b,h){var e=this.table.tBodies[0].rows;for(var g=0;g<e.length;g++){var f=e[g];var c=0;var a=$(f).offset().top;
if(f.offsetHeight==0){var d=parseInt(f.firstChild.offsetHeight)/2;}else{var d=parseInt(f.offsetHeight)/2;}if((h>(a-d))&&(h<(a+d))){if(this.indentEnabled){for(g in this.rowObject.group){if(this.rowObject.group[g]==f){return null;}}}else{if(f==this.rowObject.element){return null;}}if(!this.rowObject.isValidSwap(f)){return null;}while($(f).is(":hidden")&&$(f).prev("tr").is(":hidden")){f=$(f).prev("tr").get(0);}return f;}}return null;};Drupal.tableDrag.prototype.updateFields=function(a){for(var b in this.tableSettings){this.updateField(a,b);}};Drupal.tableDrag.prototype.updateField=function(i,k){var b=this.rowSettings(k,i);if(b.relationship=="self"||b.relationship=="group"){var e=i;}else{if(b.relationship=="sibling"){var o=$(i).prev("tr").get(0);var m=$(i).next("tr").get(0);var e=i;if($(o).is(".draggable")&&$("."+k,o).length){if(this.indentEnabled){if($(".indentations",o).size()==$(".indentations",i)){e=o;}}else{e=o;}}else{if($(m).is(".draggable")&&$("."+k,m).length){if(this.indentEnabled){if($(".indentations",m).size()==$(".indentations",i)){e=m;
}}else{e=m;}}}}else{if(b.relationship=="parent"){var o=$(i).prev("tr");while(o.length&&$(".indentation",o).length>=this.rowObject.indents){o=o.prev("tr");}if(o.length){e=o[0];}else{e=$("tr.draggable:first").get(0);if(e==this.rowObject.element){e=$(this.rowObject.group[this.rowObject.group.length-1]).next("tr.draggable").get(0);}var d=true;}}}}this.copyDragClasses(e,i,k);b=this.rowSettings(k,i);if(d){b.relationship="sibling";b.source=b.target;}var l="."+b.target;var g=$(l,i).get(0);if(g){var c="."+b.source;var a=$(c,e).get(0);switch(b.action){case"depth":g.value=$(".indentation",$(a).parents("tr:first")).size();break;case"match":g.value=a.value;break;case"order":var h=this.rowObject.findSiblings(b);if($(g).is("select")){var j=new Array();$("option",g).each(function(){j.push(this.value);});var p=j[j.length-1];$(l,h).each(function(){if(j.length>0){this.value=j.shift();}else{this.value=p;}});}else{var f=parseInt($(l,h[0]).val())||0;$(l,h).each(function(){this.value=f;f++;});}break;}}};Drupal.tableDrag.prototype.copyDragClasses=function(e,c,d){var b=$("."+d,e);
var a=$("."+d,c);if(b.length&&a.length){a[0].className=b[0].className;}};Drupal.tableDrag.prototype.checkScroll=function(c){var h=document.documentElement;var a=document.body;var g=this.windowHeight=window.innerHeight||(h.clientHeight&&h.clientWidth!=0?h.clientHeight:a.offsetHeight);var e=this.scrollY=(document.all?(!h.scrollTop?a.scrollTop:h.scrollTop):(window.pageYOffset?window.pageYOffset:window.scrollY));var d=this.scrollSettings.trigger;var f=0;if(c-e>g-d){f=d/(g+e-c);f=(f>0&&f<d)?f:d;return f*this.scrollSettings.amount;}else{if(c-e<d){f=d/(c-e);f=(f>0&&f<d)?f:d;return -f*this.scrollSettings.amount;}}};Drupal.tableDrag.prototype.setScroll=function(b){var a=this;this.scrollInterval=setInterval(function(){a.checkScroll(a.currentMouseCoords.y);var d=a.scrollY>a.table.topY;var c=a.scrollY+a.windowHeight<a.table.bottomY;if(b>0&&c||b<0&&d){window.scrollBy(0,b);}},this.scrollSettings.interval);};Drupal.tableDrag.prototype.restripeTable=function(){$("tr.draggable",this.table).filter(":odd").filter(".odd").removeClass("odd").addClass("even").end().end().filter(":even").filter(".even").removeClass("even").addClass("odd");
};Drupal.tableDrag.prototype.onDrag=function(){return null;};Drupal.tableDrag.prototype.onDrop=function(){return null;};Drupal.tableDrag.prototype.row=function(a,f,b,e,c){this.element=a;this.method=f;this.group=new Array(a);this.groupDepth=$(".indentation",a).size();this.changed=false;this.table=$(a).parents("table:first").get(0);this.indentEnabled=b;this.maxDepth=e;this.direction="";if(this.indentEnabled){this.indents=$(".indentation",a).size();this.children=this.findChildren(c);this.group=$.merge(this.group,this.children);for(var d=0;d<this.group.length;d++){this.groupDepth=Math.max($(".indentation",this.group[d]).size(),this.groupDepth);}}};Drupal.tableDrag.prototype.row.prototype.findChildren=function(e){var a=this.indents;var c=$(this.element,this.table).next("tr.draggable");var d=new Array();var f=0;while(c.length){var b=$(".indentation",c).length;if(b>a){f++;d.push(c[0]);if(e){$(".indentation",c).each(function(g){if(f==1&&(g==a)){$(this).addClass("tree-child-first");}if(g==a){$(this).addClass("tree-child");
}else{if(g>a){$(this).addClass("tree-child-horizontal");}}});}}else{break;}c=c.next("tr.draggable");}if(e&&d.length){$(".indentation:nth-child("+(a+1)+")",d[d.length-1]).addClass("tree-child-last");}return d;};Drupal.tableDrag.prototype.row.prototype.isValidSwap=function(b){if(this.indentEnabled){var c,a;if(this.direction=="down"){c=b;a=$(b).next("tr").get(0);}else{c=$(b).prev("tr").get(0);a=b;}this.interval=this.validIndentInterval(c,a);if(this.interval.min>this.interval.max){return false;}}if(this.table.tBodies[0].rows[0]==b&&$(b).is(":not(.draggable)")){return false;}return true;};Drupal.tableDrag.prototype.row.prototype.swap=function(a,b){$(b)[a](this.group);this.changed=true;this.onSwap(b);};Drupal.tableDrag.prototype.row.prototype.validIndentInterval=function(d,a){var c,b;c=a?$(".indentation",a).size():0;if(!d||$(this.element).is(".tabledrag-root")){b=0;}else{b=$(".indentation",d).size()+($(d).is(".tabledrag-leaf")?0:1);if(this.maxDepth){b=Math.min(b,this.maxDepth-(this.groupDepth-this.indents));
}}return{min:c,max:b};};Drupal.tableDrag.prototype.row.prototype.indent=function(b){if(!this.interval){prevRow=$(this.element).prev("tr").get(0);nextRow=$(this.group).filter(":last").next("tr").get(0);this.interval=this.validIndentInterval(prevRow,nextRow);}var a=this.indents+b;a=Math.max(a,this.interval.min);a=Math.min(a,this.interval.max);b=a-this.indents;for(var c=1;c<=Math.abs(b);c++){if(b<0){$(".indentation:first",this.group).remove();this.indents--;}else{$("td:first",this.group).prepend(Drupal.theme("tableDragIndentation"));this.indents++;}}if(b){this.changed=true;this.groupDepth+=b;this.onIndent();}return b;};Drupal.tableDrag.prototype.row.prototype.findSiblings=function(g){var f=new Array();var h=new Array("prev","next");var a=this.indents;for(var e in h){var c=$(this.element)[h[e]]();while(c.length){if($("."+g.target,c)){if(this.indentEnabled){var b=$(".indentation",c).length;}if(!(this.indentEnabled)||(b==a)){f.push(c[0]);}else{if(b<a){break;}}}else{break;}c=$(c)[h[e]]();}if(h[e]=="prev"){f.reverse();
f.push(this.element);}}return f;};Drupal.tableDrag.prototype.row.prototype.removeIndentClasses=function(){for(n in this.children){$(".indentation",this.children[n]).removeClass("tree-child").removeClass("tree-child-first").removeClass("tree-child-last").removeClass("tree-child-horizontal");}};Drupal.tableDrag.prototype.row.prototype.markChanged=function(){var b=Drupal.theme("tableDragChangedMarker");var a=$("td:first",this.element);if($("span.tabledrag-changed",a).length==0){a.append(b);}};Drupal.tableDrag.prototype.row.prototype.onIndent=function(){return null;};Drupal.tableDrag.prototype.row.prototype.onSwap=function(a){return null;};Drupal.theme.prototype.tableDragChangedMarker=function(){return'<span class="warning tabledrag-changed">*</span>';};Drupal.theme.prototype.tableDragIndentation=function(){return'<div class="indentation">&nbsp;</div>';};Drupal.theme.prototype.tableDragChangedWarning=function(){return'<div class="warning">'+Drupal.theme("tableDragChangedMarker")+" "+Drupal.t("Changes made in this table will not be saved until the form is submitted.")+"</div>";
};