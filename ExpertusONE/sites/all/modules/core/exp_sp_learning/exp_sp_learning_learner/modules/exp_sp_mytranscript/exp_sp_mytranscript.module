<?php
/**
 * Implementation of hook_block_info().
 */
function exp_sp_mytranscript_block_info() {
	try{
  $blocks = array();
  $blocks['mytranscript'] = array(
    'info' => t('LBL009'),
  	'cache' => DRUPAL_CACHE_PER_ROLE,
    'visibility' => BLOCK_VISIBILITY_NOTLISTED,
    'pages' => 'learning/my-profile
    learning/my-profile/skils
    *'
  );
  $blocks['mytranscript_mylearning'] = array(
  		'info' => t('New theme mytranscript'),
  		'cache' => DRUPAL_CACHE_PER_ROLE,
  		'visibility' => BLOCK_VISIBILITY_NOTLISTED,
  		'pages' => 'learning/enrollment-search'
    
  );

  return $blocks;
  } catch (Exception $ex) {
  	watchdog_exception('exp_sp_mytranscript_block_info', $ex);
  	expertusErrorThrow($ex);
  }
}

/**
 * Implements hook_block_configure().
 */
function exp_sp_mytranscript_block_configure($delta = '') {
	try{
  global $user;
  
  switch ($delta) {
    case 'mytranscript':
  //  case 'mytranscript_mylearning':
      $form['exp_sp_mytranscript_block_max_list_count'] = array('#type' => 'select', '#title' => t('No of transcript items'), '#default_value' => variable_get('exp_sp_mytranscript_block_max_list_count', 10), '#options' => drupal_map_assoc(array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20)), '#description' => t('Maximum number of My Trascript details to be displayed.'));
      return $form;
  }
  } catch (Exception $ex) {
  	watchdog_exception('exp_sp_mytranscript_block_configure', $ex);
  	expertusErrorThrow($ex);
  }
}

/**
 * Implements hook_block_save().
 */
function exp_sp_mytranscript_block_save($delta = '', $edit = array()) {
	try{
  global $user;

  switch ($delta) {
    case 'mytranscript':
    //case 'mytranscript_mylearning':
      variable_set('exp_sp_mytranscript_block_max_list_count', $edit['exp_sp_mytranscript_block_max_list_count']);
      break;
  }
  } catch (Exception $ex) {
  	watchdog_exception('exp_sp_mytranscript_block_save', $ex);
  	expertusErrorThrow($ex);
  }
}


/**
 * Implementation of hook_menu().
 */
function exp_sp_mytranscript_menu($delta = '') {
  try{
  $items = array();
  
  $items['learning/my-transcript/%'] = array (
    'title' => 'Fetch the list of transcript details',
  	'page callback' => 'get_transcript_details',
    'page arguments' => array(2),
  	'type' => MENU_CALLBACK,
  	'access arguments' => array('expertus learner'),
  	'file' => 'exp_sp_mytranscript.inc'
  );
  
  
  return $items;
  } catch (Exception $ex) {
  	watchdog_exception('exp_sp_mytranscript_menu', $ex);
  	expertusErrorThrow($ex);
  }
}

/**
 * Implements hook_block_view().
 */
function exp_sp_mytranscript_block_view($delta = '') {
	try{
  global $user, $user_preference, $theme_key;
  
  $js_module_optional = array('type' => 'file', 'group' => JS_DEFAULT);
  $css_module_optional = array('type' => 'file', 'group' => CSS_DEFAULT);
  global $theme_key,$language;
  $block = array();
  expDebug::dPrint('testtest123'.$delta);
  switch ($delta) {
    case 'mytranscript':
    if($theme_key == 'expertusoneV2') {
    //NEWUI THEME STYLE SHEET	
      drupal_add_css(drupal_get_path('module', 'exp_sp_mytranscript').'/exp_sp_mytranscript_v2.css', $css_module_optional);
    }else {
      drupal_add_css(drupal_get_path('module', 'exp_sp_mytranscript').'/exp_sp_mytranscript.css', $css_module_optional);
    }
      drupal_add_js(drupal_get_path('module', 'exp_sp_mytranscript').'/exp_sp_mytranscript.js',$js_module_optional);
      includeJqGridJsCss();
      if(arg(1)=='my-profile'){
      $block['subject'] = t('LBL877');
      }else{
      		$block['subject'] = t('LBL009');
      }
      $msg = ($title == t('LBL877'))? t('MSG252'): t('MSG607');
      
      $content = '
      <input id="exp_sp_mytranscript_block_max_list_count" type="hidden" value="'. variable_get('exp_sp_mytranscript_block_max_list_count', 5).'"/>
      <div id="my_transcript_loader" class="my-transcript-content">
      <div class="my-transcript-inner">
      <div id="my_transcript_msg" class="my-transcript-msg" style="display:none;">
      '. $msg .'
      </div>
      <div id="my_transcript_list">
      <table id ="my_transcript_jqgrid"></table>
      <div id="my_transcript_pager" class="my-transcript-pager" style="display:block;"></div>
      </div>
      </div>
      </div>';
      
       if ($theme_key == 'expertusoneV2' && !isset($user_preference['mylearning_right']['mytranscript']) && (arg(1) == 'enrollment-search' || arg(1) == 'mylearning')) {
       	$block_content = '';
       } else {
       	$block_content = $content;
       }
      $block['content'] =  $block_content;
      break;
    case 'mytranscript_mylearning':
    	$css_module_optional = array('type' => 'file', 'group' => CSS_DEFAULT);
    	drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/exp_sp_mylearning.js',$js_module_optional);
    	drupal_add_css(drupal_get_path('module', 'exp_sp_mytranscript').'/exp_sp_mytranscript_v2.css', $css_module_optional);
    	drupal_add_js(drupal_get_path('module', 'exp_sp_mytranscript').'/exp_sp_mytranscript.js',$js_module_optional);
    	includeJqGridJsCss();
    	$block['subject'] = '';
    	$content = '<div id="user-mytranscript-settings">
					<div class="vtip" title="'.t("LBL009").'"><div class="transcripticon" onclick="showUserMyTranscriptSettings()"><span class="my-mytranscript-arrow-new" id="my-mytranscript-arrow-new"></span></div>
					</div></div>';
    	expDebug::dPrint('addlist conetnt value123:' . print_r($content, 1));
    	$block['content'] = $content;
    	break;
    	
  }
  
  return $block;
  } catch (Exception $ex) {
  	watchdog_exception('exp_sp_mytranscript_block_view', $ex);
  	expertusErrorThrow($ex);
  }
}

/*
 * Implementation of hook_theme
 */
function exp_sp_mytranscript_theme() {
	try{
  return array(
  	'mytranscript-short' => array('
  		variables' => array('results' => array()),
        'template' => 'exp_sp_mytranscript-view' 
        ),
    );
  } catch (Exception $ex) {
  	watchdog_exception('exp_sp_mytranscript_theme', $ex);
  	expertusErrorThrow($ex);
  }
}
