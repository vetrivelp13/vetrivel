(function(a){Drupal.drupalchat=Drupal.drupalchat||{};Drupal.drupalchat.chatboxTimeout=Drupal.drupalchat.chatboxTimeout||{};Drupal.drupalchat.processChatDataNodejs=function(f){var l=f;if(l.length>0){var d=swfobject.getObjectById("drupalchatbeep");if(d&&Drupal.settings.drupalchat.notificationSound==1){try{d.drupalchatbeep();}catch(i){}}}var k="";var n="";var o="";if(l.displayAs=="R"){k=l.fromUserId;n=l.fromUsername;o=l.fromUserFullName;}else{k=l.forUserId;n=l.forUsername;o=l.forUserFullName;}if(jQuery("#chatbox_"+k).length<=0){createChatBox(k,o,1);}else{var j=new Date().getTime();jQuery("#chatbox_"+k).data("age",j);if(jQuery("#chatbox_"+k).css("display")=="none"){jQuery("#chatbox_"+k).css("display","block").removeClass("autohidden");jQuery("#chatbox_"+k+" .subpanel_title").click();limitChatboxesDisplayByViewportWidth();jQuery("#chatbox_"+k+" .chatboxtextarea").focus();}}jQuery("#chatbox_"+k+" .subpanel_title").addClass("newchatmsg");for(var b in l.msgsList){l.msgsList[b].msg=l.msgsList[b].msg.replace(/{{drupalchat_newline}}/g,"<br />");
l.msgsList[b].msg=l.msgsList[b].msg.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;");l.msgsList[b].msg=Drupal.drupalchat.urlify(l.msgsList[b].msg);if(Drupal.settings.drupalchat.enableSimleys==1){l.msgsList[b].msg=emotify(l.msgsList[b].msg);}if(jQuery("#chatbox_"+k+" .chatboxcontent .chatboxusername span.chatmsgusername:last").attr("title")==l.fromUserFullName&&jQuery("#chatbox_"+k+" .chatboxcontent .chatboxusername span.chatmsgusername:last").parent().parent().nextAll(".conversation-time").length<=0){if(jQuery("#chatbox_"+k+" .chatboxcontent .jspPane").length>0){jQuery("#chatbox_"+k+" .chatboxcontent .jspPane").append("<p><span>"+l.msgsList[b].msg+"</span></p>");var m=jQuery("#chatbox_"+k+" .chatboxcontent").jScrollPane({});var h=m.data("jsp");h.scrollToPercentY(100);}else{jQuery("#chatbox_"+k+" .chatboxcontent").append("<p><span>"+l.msgsList[b].msg+"</span></p>");}}else{var c=(l.fromUsername==drupalchat_htmlspecialchars_decode(Drupal.settings.drupalchat.username,"ENT_QUOTES"))?Drupal.settings.drupalchat.me:l.fromUserFullName;
var g='<p><span class="chatboxusername"><span class="chatmsgusername" title="'+l.fromUserFullName+'">'+titleRestricted(c,16)+":&nbsp;</span></span><span>"+l.msgsList[b].msg+"</span>";"</p>";if(jQuery("#chatbox_"+k+" .chatboxcontent .jspPane").length>0){jQuery("#chatbox_"+k+" .chatboxcontent .jspPane").append(g);var m=jQuery("#chatbox_"+k+" .chatboxcontent").jScrollPane({});var h=m.data("jsp");h.scrollToPercentY(100);}else{jQuery("#chatbox_"+k+" .chatboxcontent").append(g);}}if(l.hasOwnProperty("fromUserStatus")){if(l.fromUserStatus==1){jQuery("#chatbox_"+l.fromUserId+" .subpanel_title > div > div > div > div").removeClass("status-1").addClass("status-0");}else{jQuery("#chatbox_"+l.fromUserId+" .subpanel_title > div > div > div > div").removeClass("status-0").addClass("status-1");}}if(Drupal.drupalchat.chatboxTimeout.hasOwnProperty(k)){clearTimeout(Drupal.drupalchat.chatboxTimeout[k].timeout);}delete Drupal.drupalchat.chatboxTimeout[k];Drupal.drupalchat.chatboxTimeout[k]={};Drupal.drupalchat.chatboxTimeout[k].timeout=setTimeout('Drupal.drupalchat.appendConversationTime("'+k+'")',Drupal.settings.drupalchat.showChatTimeAfter);
Drupal.drupalchat.chatboxTimeout[k].msgid="";}jQuery("#chatbox_"+k+" .chatboxcontent").scrollTop(jQuery("#chatbox_"+k+" .chatboxcontent")[0].scrollHeight);jQuery.titleAlert(Drupal.settings.drupalchat.newMessage,{requireBlur:true,stopOnFocus:true,interval:800});expSaveToPersistentStorage();vtip();};Drupal.drupalchat.processUserOnlineWithInsertInfo=function(f){jQuery("#chatpanel .subpanel ul li.drupalchatnousers").remove();var c=f.insertInfo.after==null?[]:jQuery("a#drupalchat_user_"+f.insertInfo.after.uid);c=c.length==0?null:c.parent();var n=f.insertInfo.before==null?[]:jQuery("a#drupalchat_user_"+f.insertInfo.before.uid);n=n.length==0?null:n.parent();var h=parseInt(jQuery("#chatpanel .online-count").html());if(c==null&&n==null){var k=f.name.toUpperCase();var d=false;var i=false;var g=null;jQuery("#chatpanel .subpanel ul li").each(function(){var o=a(this).text().toUpperCase();if(o==k){i=true;return false;}if(o>k){g=a(this);d=true;return false;}});if(d){g.before(f.onlineUserHTML);jQuery("#chatpanel .signin-signout-arrow").show();
jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .online-count").html(h+1);}else{if(!i){jQuery("#chatpanel .subpanel ul").append(f.onlineUserHTML);jQuery("#chatpanel .signin-signout-arrow").show();jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .online-count").html(h+1);}}}else{if(c==null){var m=n.prev();var k=f.name.toUpperCase();var b=false;var i=false;while(m.length!=0){var l=a(m).text().toUpperCase();if(l==k){i=true;break;}if(l<k){b=true;break;}m=m.prev();}if(b){m.after(f.onlineUserHTML);jQuery("#chatpanel .signin-signout-arrow").show();jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .online-count").html(h+1);}else{if(!i){jQuery("#chatpanel .subpanel ul").prepend(f.onlineUserHTML);jQuery("#chatpanel .signin-signout-arrow").show();jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .online-count").html(h+1);}}}else{if(n==null){var j=c.next();var k=f.name.toUpperCase();var d=false;var i=false;while(j.length!=0){var l=a(j).text().toUpperCase();
if(l==k){i=true;break;}if(l>k){d=true;break;}j=j.next();}if(d){j.before(f.onlineUserHTML);jQuery("#chatpanel .signin-signout-arrow").show();jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .online-count").html(h+1);}else{if(!i){jQuery("#chatpanel .subpanel ul").append(f.onlineUserHTML);jQuery("#chatpanel .signin-signout-arrow").show();jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .online-count").html(h+1);}}}else{var j=c.next();var k=f.name.toUpperCase();var d=false;var i=false;var e=a(n).children("a").attr("id");while(j.length!=0&&a(j).children("a").attr("id")!=e){var l=a(j).text().toUpperCase();if(l==k){i=true;break;}if(l>k){d=true;break;}j=j.next();}if(d){j.before(f.onlineUserHTML);jQuery("#chatpanel .signin-signout-arrow").show();jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .online-count").html(h+1);}else{if(!i){if(j.length==0){jQuery("#chatpanel .subpanel ul").append(f.onlineUserHTML);}else{j.before(f.onlineUserHTML);}jQuery("#chatpanel .signin-signout-arrow").show();
jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .online-count").html(h+1);}}}}}h=parseInt(jQuery("#chatpanel .online-count").html());if(h>=5){jQuery("#chatpanel .subpanel .item-list").css({height:"200"});jQuery("#chatpanel .subpanel .item-list").jScrollPane({showArrows:true});}jQuery("#chatbox_"+f.uid+" .subpanel_title > div > div > div > div").removeClass("status-0").addClass("status-1");jQuery(".chatmsguserpic.uid"+f.uid).attr("src","/sites/default/files/pictures/"+f.pictureFilename);this.currTheme=Drupal.settings.ajaxPageState.theme;if(this.currTheme=="expertusoneV2"){jQuery("#drupalchat .subpanel .item-list ul li a").css({width:"186"});}else{jQuery("#drupalchat .subpanel .item-list ul li a").css({width:"175"});}expSaveToPersistentStorage();vtip();};Drupal.drupalchat.processUsersOnlineList=function(b){jQuery("#chatpanel .subpanel ul").empty();jQuery("#chatpanel .subpanel ul").append(b.onlineUsersListHtml);jQuery("#chatpanel .signin-signout-arrow").show();jQuery("#chatpanel .count_class").show();
jQuery("#chatpanel .online-count").html(b.count);if(jQuery("#chatpanel .subpanel ul > li").length>=5){jQuery("#chatpanel .subpanel .item-list").css({height:"200"});jQuery("#chatpanel .subpanel").css({height:"200"});var c="";jQuery("#chatpanel .subpanel .item-list").bind("jsp-initialised",function(e,d){if(jQuery("#chatpanel").find(".jspDrag").height()<30){jQuery("#chatpanel").find(".jspDrag").css("height","30px");}}).bind("jsp-scroll-y",function(f,e,h,d){var g=Math.round(e);if(g==0){c=10;return false;}if(d!=true){if(g>c){jQuery("#chatpanel").find(".jspPane").css("top",-g-10-parseInt(Drupal.settings.drupalchat.onlineUsersListScrollingSetting)+"px");c=g+10+parseInt(Drupal.settings.drupalchat.onlineUsersListScrollingSetting);return false;}if(g<c){jQuery("#chatpanel").find(".jspPane").css("top",-g+10+parseInt(Drupal.settings.drupalchat.onlineUsersListScrollingSetting)+"px");c=g-10-parseInt(Drupal.settings.drupalchat.onlineUsersListScrollingSetting);return false;}}}).jScrollPane({showArrows:true,autoReinitialise:true});
}jQuery(".chatbox").each(function(){var d=a(this).attr("id").replace("chatbox_","");if(b.onlineUsersList.hasOwnProperty(d)){jQuery("#chatbox_"+d+" .subpanel_title > div > div > div > div").removeClass("status-0").addClass("status-1");jQuery(".chatmsguserpic.uid"+d).attr("src","/sites/default/files/pictures/"+b.onlineUsersList[d].pictureFilename);}});this.currTheme=Drupal.settings.ajaxPageState.theme;if(this.currTheme=="expertusoneV2"){jQuery("#drupalchat .subpanel .item-list ul li a").css({width:"186"});}else{jQuery("#drupalchat .subpanel .item-list ul li a").css({width:"175"});}expSaveToPersistentStorage();vtip();};Drupal.drupalchat.processUserPicture=function(b){if(b.uid==Drupal.settings.drupalchat.uid){Drupal.drupalchat.userPictureFileName=b.pictureFilename;}else{jQuery(".onlineuserpic.uid"+b.uid).attr("src","/sites/default/files/pictures/"+b.pictureFilename);}jQuery(".chatmsguserpic.uid"+b.uid).attr("src","/sites/default/files/pictures/"+b.pictureFilename);expSaveToPersistentStorage();
};Drupal.drupalchat.processNoReceiverForMsg=function(j){var k=j.uid2;var c=j.msgIdList;for(var d in c){if(Drupal.drupalchat.chatboxTimeout.hasOwnProperty(k)&&Drupal.drupalchat.chatboxTimeout[k].msgid==c[d]){clearTimeout(Drupal.drupalchat.chatboxTimeout[k].timeout);delete Drupal.drupalchat.chatboxTimeout[k];}jQuery("."+c[d]).addClass("undelivered");var g=jQuery("."+c[d]).parent().prev();if(g.length>0&&g.hasClass("undelivered-errmsg")){g.remove();}var b=jQuery("."+c[d]).parent().next();if(b.length>0&&b.hasClass("conversation-time")){b.remove();}}if(c.length>0){jQuery("."+c[d]).parent().after('<p class="undelivered-errmsg"><i>'+jQuery("#chatbox_"+k+" .chatboxhead .subpanel_title_text").text()+"</i> "+Drupal.settings.drupalchat.undeliveredErrorMsg+"</p>");}if(jQuery("#chatbox_"+k+" .chatboxcontent .jspPane").length>0){var l=jQuery("#chatbox_"+k+" .chatboxcontent").jScrollPane({});var h=l.data("jsp");h.scrollToPercentY(100);}jQuery("#chatbox_"+k+" .chatboxcontent").scrollTop(jQuery("#chatbox_"+k+" .chatboxcontent")[0].scrollHeight);
expSaveToPersistentStorage();var f=swfobject.getObjectById("drupalchatbeep");if(f&&Drupal.settings.drupalchat.notificationSound==1){try{f.drupalchatbeep();}catch(i){}}};Drupal.drupalchat.processUserOffline=function(e){if(e!=Drupal.settings.drupalchat.uid){if(jQuery("#drupalchat_user_"+e).length>0){jQuery("#drupalchat_user_"+e).parent().remove();var b=parseInt(jQuery("#chatpanel .online-count").html())-1;jQuery("#chatpanel .signin-signout-arrow").show();jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .online-count").html(b);if(b==0){jQuery("#chatpanel .subpanel > .item-list").remove();if(Drupal.settings.drupalchat.signInState==2){jQuery("#chatpanel .subpanel").append(Drupal.settings.drupalchat.noUsers);}else{jQuery("#chatpanel .subpanel").append(Drupal.settings.drupalchat.signedOut);}}}jQuery("#chatbox_"+e+" .subpanel_title > div > div > div > div").removeClass("status-1").addClass("status-0");if(b<=5){var c=a("#chatpanel .subpanel .item-list").jScrollPane({showArrows:true});
var d=c.data("jsp");d.destroy();jQuery("#chatpanel .subpanel .item-list").css({height:"auto"});}}expSaveToPersistentStorage();};Drupal.drupalchat.processSignedIn=function(d){Drupal.settings.drupalchat.signInState=2;jQuery("#chatpanel .icon").attr("src",Drupal.settings.drupalchat.images+"online.png");a("#drupalchat").find(".chat-signin-bg-setting").removeClass("chat-signin-bg-setting");a("#drupalchat").closest("#drupalchat-wrapper").removeClass("offline");jQuery("#chatpanel .count_class").show();jQuery("#chatpanel .signin-signout-arrow").show();a("#drupalchat .change-signin-state").html(Drupal.settings.drupalchat.signOutOfChat);a("#drupalchat .change-signin-state").attr("title",Drupal.settings.drupalchat.signOutOfChat);a("#drupalchat .signin-signout-arrow").attr("title",Drupal.settings.drupalchat.signOutOfChat);if(d.count==0){jQuery("#chatpanel .online-count").html(0);jQuery("#chatpanel .subpanel > .item-list").remove();jQuery("#chatpanel .subpanel").append(Drupal.settings.drupalchat.noUsers);
var b=a("#chatpanel .subpanel .item-list").jScrollPane({showArrows:true});var c=b.data("jsp");c.destroy();jQuery("#chatpanel .subpanel .item-list").css({height:"auto"});expSaveToPersistentStorage();}else{Drupal.drupalchat.processUsersOnlineList(d);}};Drupal.drupalchat.processSignedOut=function(d){Drupal.settings.drupalchat.signInState=1;jQuery("#chatpanel .icon").attr("src",Drupal.settings.drupalchat.images+"offline.png");a("#drupalchat").find(".signin-signout-container").addClass("chat-signin-bg-setting");a("#drupalchat").closest("#drupalchat-wrapper").addClass("offline");a("#drupalchat .change-signin-state").html(Drupal.settings.drupalchat.signIntoChat);a("#drupalchat .change-signin-state").attr("title",Drupal.settings.drupalchat.signIntoChat);a("#drupalchat .signin-signout-arrow").attr("title",Drupal.settings.drupalchat.signIntoChat);jQuery("#chatpanel .count_class").hide();jQuery("#chatpanel .signin-signout-arrow").hide();jQuery("#chatpanel .subpanel > .item-list").remove();jQuery("#chatpanel .subpanel").append(Drupal.settings.drupalchat.signedOut);
jQuery(".chatbox .subpanel_title > div > div > div > div").removeClass("status-1").addClass("status-0");var b=a("#chatpanel .subpanel .item-list").jScrollPane({showArrows:true});var c=b.data("jsp");c.destroy();jQuery("#chatpanel .subpanel").css({height:"auto"});jQuery("#chatpanel .subpanel .item-list").css({height:"auto"});expSaveToPersistentStorage();};Drupal.drupalchat.processLoggedOut=function(b){if(typeof resource.base_url!=undefined){window.location.replace(resource.base_url);}};Drupal.drupalchat.sendMessagesNodejs=function(c,b){Drupal.Nodejs.socket.emit("message",{type:"newMessage",uid1:c,msgObjList:b});};Drupal.Nodejs.callbacks.drupalchatNodejsMessageHandler={callback:function(b){if(typeof Drupal.settings.drupalchat==="undefined"){return;}switch(b.type){case"newMessage":Drupal.drupalchat.processChatDataNodejs(b.data);break;case"noReceiverForMsg":Drupal.drupalchat.processNoReceiverForMsg(b.data);break;case"userOnline":Drupal.drupalchat.processUserOnlineWithInsertInfo(b.data);break;
case"onlineUsersList":Drupal.drupalchat.processUsersOnlineList(b.data);break;case"userPictureChanged":Drupal.drupalchat.processUserPicture(b.data);break;case"userOffline":Drupal.drupalchat.processUserOffline(b.data);break;case"signedIn":Drupal.drupalchat.processSignedIn(b.data);break;case"signedOut":Drupal.drupalchat.processSignedOut(b.data);break;case"loggedOut":Drupal.drupalchat.processLoggedOut(b.data);break;}if(b.hasOwnProperty("ack")&&b.ack===true){Drupal.Nodejs.socket.emit("message-processed",{});}}};Drupal.Nodejs.connectionSetupHandlers.drupalchatNodejsConnectionSetupHandlers={disconnect:function(){if(typeof Drupal.settings.drupalchat==="undefined"){return;}if(Drupal.settings.drupalchat.signInState==2){a("#chatpanel .subpanel .item-list").replaceWith(Drupal.settings.drupalchat.noUsers);}else{a("#chatpanel .subpanel .item-list").replaceWith(Drupal.settings.drupalchat.signedOut);}jQuery("#chatpanel .online-count").html(0);jQuery(".chatbox .subpanel_title > div > div > div > div").removeClass("status-1").addClass("status-0");
jQuery("#chatpanel .icon").attr("src",Drupal.settings.drupalchat.images+"loading.gif");},connecting:function(){if(typeof Drupal.settings.drupalchat==="undefined"){return;}jQuery("#chatpanel .icon").attr("src",Drupal.settings.drupalchat.images+"loading.gif");},connect:function(){if(typeof Drupal.settings.drupalchat==="undefined"){return;}},connectionFailure:function(){if(typeof Drupal.settings.drupalchat==="undefined"){return;}a("#drupalchat").closest("#drupalchat-wrapper").addClass("offline");jQuery("#chatpanel .icon").attr("src",Drupal.settings.drupalchat.images+"offline.png");jQuery("#chatpanel .count_class").hide();jQuery("#chatpanel .signin-signout-arrow").hide();expSaveToPersistentStorage();},connectionFatalFailure:function(){a("#drupalchat").closest("#drupalchat-wrapper").addClass("offline");jQuery("#chatpanel .icon").attr("src",Drupal.settings.drupalchat.images+"offline.png");jQuery("#chatpanel .count_class").hide();jQuery("#chatpanel .signin-signout-arrow").hide();expSaveToPersistentStorage();
},expAuthenticated:function(b){if(typeof Drupal.settings.drupalchat==="undefined"){return;}if(Drupal.settings.drupalchat.signInState==2){jQuery("#chatpanel .icon").attr("src",Drupal.settings.drupalchat.images+"online.png");jQuery("#drupalchat .signin-signout-arrow").attr("title",Drupal.settings.drupalchat.signOutOfChat);}else{a("#drupalchat").closest("#drupalchat-wrapper").addClass("offline");jQuery("#chatpanel .icon").attr("src",Drupal.settings.drupalchat.images+"offline.png");jQuery("#chatpanel .count_class").hide();jQuery("#chatpanel .signin-signout-arrow").hide();jQuery("#drupalchat .signin-signout-arrow").attr("title",Drupal.settings.drupalchat.signIntoChat);}expSaveToPersistentStorage();},expAuthFailed:function(b){if(typeof Drupal.settings.drupalchat==="undefined"){return;}a("#drupalchat").closest("#drupalchat-wrapper").addClass("offline");jQuery("#chatpanel .count_class").hide();jQuery("#chatpanel .signin-signout-arrow").hide();jQuery("#chatpanel .icon").attr("src",Drupal.settings.drupalchat.images+"offline.png");
expSaveToPersistentStorage();}};})(jQuery);