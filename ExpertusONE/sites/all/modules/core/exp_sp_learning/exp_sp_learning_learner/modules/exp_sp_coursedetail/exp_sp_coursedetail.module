<?php
/**
 * Implementation of hook_block_info().
 */
function exp_sp_coursedetail_block_info() {
  try{
  $blocks = array();
 
  $blocks['course_details'] = array(
    'info' => t('Course/Delivery Type Details - Course'),
  	'cache' => DRUPAL_CACHE_PER_ROLE,  
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => 'learning/course-details/*'
  );
  $blocks['course_forums'] = array(
    'info' => t('Discussion Forum - Course'),
  	'cache' => DRUPAL_CACHE_PER_ROLE,  
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => 'learning/course-details/*'
  );
  $blocks['course_blogs'] = array(
    'info' => t('Blogs - Course'),
  	'cache' => DRUPAL_CACHE_PER_ROLE,  
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => 'learning/course-details/*'
  );
  $blocks['course_related'] = array(
    'info' => t('Related Course'),
  	'cache' => DRUPAL_CACHE_PER_ROLE,  
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => 'learning/course-details/*'
  );
  $blocks['course_rating'] = array(
    'info' => t('Rating/Review - Course'),
  	'cache' => DRUPAL_CACHE_PER_ROLE,  
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => 'learning/course-details/*'
  );
  $blocks['course_categories'] = array(
    'info' => t('Categories Related - Course'),
  	'cache' => DRUPAL_CACHE_PER_ROLE,  
    'visibility' => BLOCK_VISIBILITY_LISTED,
    'pages' => 'learning/course-details/*'
  );
  return $blocks;
  }catch (Exception $ex) {
    watchdog_exception('exp_sp_coursedetail_block_info', $ex);
    expertusErrorThrow($ex);
  } 
}

/**
 * Implementation of hook_block_view().
 */
function exp_sp_coursedetail_block_view($delta = ''){
  try{
   global $user;
  	expDebug::dPrint('$delta$delta'.$delta);
  $js_module_optional = array('type' => 'file', 'group' => JS_DEFAULT);
  $css_module_optional = array('type' => 'file', 'group' => CSS_DEFAULT);
  $header_optional = array('type' => 'file', 'scope' => 'header', 'group' => JS_LIBRARY);
  $css_theme_optional = array('type' => 'file', 'group' => CSS_THEME);
  global $theme_key; 
  
  require_once('exp_sp_coursedetail.inc');
  require_once(drupal_get_path('module', 'exp_sp_classdetail').'/exp_sp_classdetail.inc');
  $block = array();
  switch ($delta) {
    case 'course_details':
      // included forum js
    	drupal_add_js(drupal_get_path('module', 'exp_sp_lnrsearch') .'/jquery.cookie.js', $js_module_optional);
      drupal_add_js(drupal_get_path('module', 'exp_sp_forum').'/exp_sp_forum.js',$js_module_optional);
      drupal_add_js(drupal_get_path('module', 'exp_sp_core').'/js/qtippopup.js',$js_module_optional);
      
      drupal_add_js(drupal_get_path('module', 'exp_sp_coursedetail').'/exp_sp_coursedetail.js',$js_module_optional);
      //Add onclick register 
      drupal_add_js(drupal_get_path('module', 'exp_sp_lnrsearch') .'/exp_sp_lnrsearch.js', $js_module_optional);
      if (contentPlayerIsActive()) {
	  	includeContentPlayerJsCss();
	  	drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_lnrenrollment/exp_sp_lnrenrollment_cp.js', $js_module_optional);
	  	drupal_add_js(drupal_get_path('module', 'exp_sp_survey').'/exp_sp_survey_learner/js/exp_sp_surveylearner/exp_sp_surveylearner_cp.js',$js_module_optional);
	  	drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_registrationdetail/exp_sp_launch_cp.js', $js_module_optional);
	  	drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_registrationdetail/SCORM-API-WRAPPER_cp.js', $js_module_optional);
	  	drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_registrationdetail/SCORM12-LMS-API_cp.js', $js_module_optional);
	  	drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_registrationdetail/SCORM2004-LMS-API_cp.js', $js_module_optional);
	  }	else {
      drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_lnrenrollment/exp_sp_lnrenrollment.js', $js_module_optional);
      drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_registrationdetail/exp_sp_launch.js', $js_module_optional);
  	  if(getConfigValue('wbt_content_launch_style') == 1) {
	  	drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_registrationdetail/SCORM-API-WRAPPER-MODAL.js', $js_module_optional);
	  } else {
	  	drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_registrationdetail/SCORM-API-WRAPPER.js', $js_module_optional);
	  }
      drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_registrationdetail/SCORM12-LMS-API.js', $js_module_optional);
      drupal_add_js(drupal_get_path('module', 'exp_sp_learning_learner').'/js/exp_sp_registrationdetail/SCORM2004-LMS-API.js', $js_module_optional);
	  }
      //drupal_add_js(drupal_get_path('module', 'exp_sp_my_profile') .'/exp_sp_my_profile.js',$js_module_optional);
      //drupal_add_js(drupal_get_path('module', 'exp_sp_my_skill') .'/exp_sp_my_skill.js',$js_module_optional);
      //drupal_add_js(drupal_get_path('module', 'exp_sp_my_activity') .'/exp_sp_my_activity.js',$js_module_optional);
      includeJqGridJsCss();
      // included forum css
      if($theme_key == 'expertusoneV2') {
         drupal_add_css(drupal_get_path('module', 'exp_sp_forum') .'/exp_sp_forum_v2.css', array('type' => 'file', 'group' => CSS_THEME, 'weight'=>1300));
         drupal_add_css(drupal_get_path('module', 'exp_sp_coursedetail').'/exp_sp_coursedetail_v2.css', $css_module_optional);
         drupal_add_css(drupal_get_path('module', 'exp_sp_prerequisite') .'/exp_sp_prerequisite_v2.css', $css_theme_optional);
         drupal_add_css(drupal_get_path('module', 'exp_sp_lnrsearch') . '/exp_sp_lnrsearch_v2.css', $css_theme_optional);
         drupal_add_css(drupal_get_path('module', 'exp_sp_learning_plan_detail').'/exp_sp_learning_plan_detail_v2.css', $css_module_optional);
         //Add onclick register
       if (contentPlayerIsActive()) { // Based on a content player activation load the needed files.
         	drupal_add_css(drupal_get_path('module', 'exp_sp_survey').'/exp_sp_survey_learner/css/Survey_formatter_cp.css',$css_theme_optional);
         	drupal_add_css(drupal_get_path('module', 'exp_sp_learning_learner') .'/css/exp_sp_lnrenrollment_cp.css', $css_module_optional);
         } else {
         drupal_add_css(drupal_get_path('module', 'exp_sp_learning_learner') .'/css/exp_sp_lnrenrollment_v2.css', $css_module_optional);
         }	
         //drupal_add_css(drupal_get_path('module', 'exp_sp_my_profile') .'/exp_sp_my_profile_v2.css', $css_theme_optional);
         //drupal_add_css(drupal_get_path('module', 'exp_sp_my_activity') .'/exp_sp_my_activity_v2.css', array('type' => 'file', 'group' => CSS_DEFAULT));
         //drupal_add_css(drupal_get_path('module','exp_sp_my_skill') .'/exp_sp_my_skill_v2.css', array('type' => 'file', 'group' => CSS_DEFAULT));
      }else{
         drupal_add_css(drupal_get_path('module', 'exp_sp_forum') .'/exp_sp_forum.css', $css_theme_optional);
         drupal_add_css(drupal_get_path('module', 'exp_sp_coursedetail').'/exp_sp_coursedetail.css', $css_module_optional);
         //drupal_add_css(drupal_get_path('module', 'exp_sp_my_profile') .'/exp_sp_my_profile.css', $css_theme_optional);
         //drupal_add_css(drupal_get_path('module', 'exp_sp_my_activity') .'/exp_sp_my_activity.css', array('type' => 'file', 'group' => CSS_DEFAULT));
         //drupal_add_css(drupal_get_path('module','exp_sp_my_skill') .'/exp_sp_my_skill.css', array('type' => 'file', 'group' => CSS_DEFAULT));
      }
      enableCtool();
      $sendArg = (arg(0) == 'home' || arg(0) == 'share') ? arg(3) :  arg(2);
  	  $course_details = getCourse_DetailsInfo($sendArg);
// 		Action button related works are commented  	  
/*  	$course_details = getCourse_DetailsInfo($sendArg);     
  		$header_details = getCatalogSearchResults($course_details->course_id,'course');
  	 	expDebug::dPrint('header details:' . print_r($header_details, 1),4);
  	 	if(count($header_details)>0){
  	 		$course_catalog_details= getCourseDetails($course_details->course_id,'','course_page_view');
  	 		$course_details->action_variables=getCourseActionDetails($header_details,$course_details->course_id,$course_catalog_details);
  		}
 		 $class_ids = getClassIds($course_details->course_id,'course_page_view');
 		$course_details->statistics->class_count = count($class_ids);
  	  	foreach ($class_ids as $class_id)
      	 	$course_details-> class_details_arr[] = getFullClassDetails($class_id->classid); */
  	  
  	
      
      /*-- Check the access enabled and view the page --*/
      
       // Added by ganeshbabuv on May 3rd 2016 5 PM to avoid to getting PHP fatal error when view the class details
      include_once(drupal_get_path('module', 'exp_sp_administration_catalog_access') .'/exp_sp_administration_catalog_access.inc');
      
      $isAccessEnabled = getEntityAccess($course_details['catalog']->id, 'cre_sys_obt_crs');
      if ($user->uid == 0 && $isAccessEnabled) {
       $viewDetailPage = false;
      } else {
       $viewDetailPage = true;
      if($isAccessEnabled) {
        $userId = getSltpersonUserId();
        $isGroupMember = checkUserEntityAccess($course_details['catalog']->id, 'cre_sys_obt_crs', $userId);
       } else {
        $isGroupMember = true;
       }
      }
      $block['subject'] = sanitize_data($course_details->data_title);
      $block['content'] =  " ";
      
      if ($viewDetailPage && $isGroupMember) {
      	
       $course_details =  getFullCourseDetails($course_details); // Collect new course information from course details
       //$block['results'] = $course_details;
     
       $block['results']['details'] = $course_details;
       $block['results']['attachments'] = getAttachmentsInfo($course_details->id,'Course');
	   /*	 $class_list =  fetch_classes_list($course_details['catalog']->id,'admin',$isFromTP=FALSE, true);
	       $class_list =  fetch_classes_list($course_details['catalog']->id,'admin',$isFromTP=FALSE);
	      if(!empty($class_list)) {
	      	foreach ($class_list->rows as $key => $results) {
	      		$class_list_only[$key] = $results['cell']['ClassId'];
	      	}
	     	}
	     $course_details['catalog']->classDetails = $class_list_only; */
       // retieving taxonomy term data id
       $block['results']['discussions'] = GetForumTopicListForDetail('catalog',$course_details->id);//Added for displaying discussions under course
       
       $additional = array (
       		"course_id" => $block['results']['details']->course_id,
       		"delivery_type" => $block ['results']['details']->delivery_type_code,
       		"preRequiste"	=>	$course_details->preRequiste,
       		"Equivalence"	=>	$course_details->Equivalence,
       );
       $block['results']['miscContent'] = getEntityMiscDetails($block['results']['details']->course_id,'Course',$additional);
       // retrieving taxonomy term data id
       $block['results']['discussions']  = GetForumTopicListForDetail('catalog',$block['results']['details']->course_id);//Added for displaying discussions under class (discussions under parent)
      }
      break;
    case 'course_forums':
      $block['subject'] = t('Discussion Forum');
      $block['content'] =  " ";
      $block['results'] = getDiscussionForum();
      break;
    case 'course_blogs':
      $block['subject'] = t('Blogs');
      $block['content'] =  " ";
      $block['results'] = getBlogsDetail();
      break;
    case 'course_related':
      $block['subject'] = t('Related Course');
      $block['content'] =  " ";
      $block['results'] = getRelatedCourse();
      break;
    case 'course_rating':
      $block['subject'] = t('Rating/Review');
      $block['content'] =  " ";
      $block['results'] = getRatingReview();
      break;
    case 'course_categories':
      $block['subject'] = t('Categories Related');
      $block['content'] =  " ";
      $block['results'] = getCategoryRelated();
      break;
  }
  return $block;
  }catch (Exception $ex) {
    watchdog_exception('exp_sp_coursedetail_block_view', $ex);
    expertusErrorThrow($ex);
  } 
}

/**
 * Implementation of hook_menu().
 */
function exp_sp_coursedetail_menu($delta = ''){
  try{
    $items = array();
    
	$items['learning/fetch-classes-list/%/%'] = array (
		'title' => 'Fetch the list of classes for the course with basic details',
		'page callback' => 'fetch_classes_list',
	    'page arguments' => array(2,3),
		'type' => MENU_CALLBACK,
	    'access arguments' => array('access content'),
		'file' => 'exp_sp_coursedetail.inc'
	);
	$items['learning/fetch-classes-list-view/%/%'] = array (
		'title' => 'Fetch the list of classes for the course',
		'page callback' => 'fetch_classes_list_view',
	    'page arguments' => array(2,3),
		'type' => MENU_CALLBACK,
	    'access arguments' => array('access content'),
		'file' => 'exp_sp_coursedetail.inc'
	);
	$items['learning/fetch-class-details/%'] = array (
		'title' => 'Fetch the details of a class',
		'page callback' => 'callback_fetch_class_details',
	    'page arguments' => array(2),
		'type' => MENU_CALLBACK,
	    'access arguments' => array('access content'),
		'file' => 'exp_sp_coursedetail.inc'
	);
	
	$items['learning/course-details'] = array(
      'title' => 'COURSE / DELIVERY TYPE DETAILS',
      'page callback' => 'empty_value',
      'access arguments' => array('catalog learner'),
      'type' => MENU_CALLBACK,
    );
    
	$items['home/learning/course-details'] = array(
      'title' => 'COURSE / DELIVERY TYPE DETAILS',
      'page callback' => 'empty_value',
      'access arguments' => array('catalog learner'),
      'type' => MENU_CALLBACK,
    );
    
   $items['share/learning/course-details'] = array(
      'title' => 'COURSE / DELIVERY TYPE DETAILS',
      'page callback' => 'empty_value',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );
   
  $items['learning/fetch-detailed-class-list/%/%'] = array (
		'title' => 'Fetch the list of classes for the course with basic details',
		'page callback' => 'fetch_detailed_class_list',
	    'page arguments' => array(2,3),
		'type' => MENU_CALLBACK,
	    'access arguments' => array('access content'),
		'file' => 'exp_sp_coursedetail.inc'
	);
	
	expDebug::dPrint(" items = ". print_r($items, true) , 4);
	
	return $items;	
  }catch (Exception $ex) {
    watchdog_exception('exp_sp_coursedetail_menu', $ex);
    expertusErrorThrow($ex);
  } 	
}

/**
 * Implementation of hook_theme().
 */
function exp_sp_coursedetail_theme() {
  try{
  return array(
     'exp_sp_class_details-view' => array
    (
      	'variables' => array('results' => array()),
      	'template' => 'exp_sp_class_details-view',
	 ),
  );
  }catch (Exception $ex) {
    watchdog_exception('exp_sp_coursedetail_theme', $ex);
    expertusErrorThrow($ex);
  } 
}

/**
 * Implementation of class details callback.
 */
function callback_fetch_class_details($classIdAndSessionId) { 
  try{ 
  echo theme("exp_sp_class_details-view", array('results' => fetch_class_details($classIdAndSessionId)));
  }catch (Exception $ex) {
    watchdog_exception('callback_fetch_class_details', $ex);
    expertusErrorThrow($ex);
  } 
}
