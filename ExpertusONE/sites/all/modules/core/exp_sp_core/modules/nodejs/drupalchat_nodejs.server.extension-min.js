var publishMessageToClient;var queueAndPublishMessageToClient;var dropMsgQueue;var settings={};var authenticatedClients={};var drupalchat_ordered_names=[];var drupalchat_users={};var drupalchat_uids={};var drupalchat_names={};var drupalchat_fullnames={};var drupalchat_pictureFilenames={};var drupalchat_signInState={};var userPresenceTimeoutIds={};var drupalchat_msgs_queue={};var drupal_visible_users={};exports.setup=function(e){publishMessageToClient=e.publishMessageToClient;queueAndPublishMessageToClient=e.queueAndPublishMessageToClient;dropMsgQueue=e.dropMsgQueue;settings=e.settings;authenticatedClients=e.authenticatedClients;var g=function(r){if(drupalchat_ordered_names.length<=0){drupalchat_ordered_names[0]=r;return;}var s=0;var p=drupalchat_ordered_names.length-1;var q=Math.floor((p+s)/2);while(s<p&&drupalchat_ordered_names[q]!=r){if(r<drupalchat_ordered_names[q]){p=q-1;}else{if(r>drupalchat_ordered_names[q]){s=q+1;}}q=Math.floor((p+s)/2);}if(q<0){q=0;}else{if(q>drupalchat_ordered_names.length-1){q=drupalchat_ordered_names.length-1;
}}if(r<drupalchat_ordered_names[q]){drupalchat_ordered_names.splice(q,0,r);}else{if(r>drupalchat_ordered_names[q]){drupalchat_ordered_names.splice(q+1,0,r);}}};var a=function(r){if(drupalchat_ordered_names.length<=0){return -1;}var s=0;var p=drupalchat_ordered_names.length-1;var q=Math.floor((p+s)/2);while(s<p&&drupalchat_ordered_names[q]!=r){if(r<drupalchat_ordered_names[q]){p=q-1;}else{if(r>drupalchat_ordered_names[q]){s=q+1;}}q=Math.floor((p+s)/2);}if(q<0){q=0;}else{if(q>drupalchat_ordered_names.length-1){q=drupalchat_ordered_names.length-1;}}if(r!=drupalchat_ordered_names[q]){return -1;}return q;};var n=function(r,q){var s={after:null,before:null};var p;for(p=q-1;p>=0&&(drupalchat_ordered_names[p]==r||drupalchat_signInState[drupalchat_ordered_names[p]]!=2);p--){}if(p>=0){s.after={name:drupalchat_ordered_names[p],uid:drupalchat_uids[drupalchat_ordered_names[p]]};}for(p=q+1;p<drupalchat_ordered_names.length&&(drupalchat_ordered_names[p]==r||drupalchat_signInState[drupalchat_ordered_names[p]]!=2);
p++){}if(p<drupalchat_ordered_names.length){s.before={name:drupalchat_ordered_names[p],uid:drupalchat_uids[drupalchat_ordered_names[p]]};}return s;};var b=function(r,p){var q;if(r.length>=p){q=r.substring(0,p);q=q+"...";}else{q=r;}return q;};var j=function(s,t,w){if(typeof drupalchat_users[s]!="undefined"){t=drupalchat_uids[s];w=drupalchat_pictureFilenames[s];}var r=settings.drupalchatNodejs.currTheme;var p=drupalchat_fullnames[t];if(r=="expertusoneV2"){var v='<span class="user-list-border-img"><img class="onlineuserpic uid'+t+'" width="32px" height="32px" alt="" src="/sites/default/files/pictures/'+w+'" style="vertical-align:middle;"></span>';var u='<span class="chatUserTitle">'+b(p,13)+"</span>";}else{var v='<img class="onlineuserpic uid'+t+'" width="32px" height="32px" alt="" src="/sites/default/files/pictures/'+w+'" style="vertical-align:middle;">';var u=b(p,16);}var q='<li class="status-1'+((settings.drupalchatNodejs.showUserPicture)?"":" nopic")+'"><a title="'+p+'" class="'+t+'" href="javascript:void(0)" id="drupalchat_user_'+t+'">'+((settings.drupalchatNodejs.showUserPicture)?v:"")+u+"</a></li>";
return q;};var l=function(r){var s="";var t={};var q=0;var p;for(p=0;p<drupalchat_ordered_names.length;p++){if(drupalchat_ordered_names[p]!=r&&drupalchat_signInState[drupalchat_ordered_names[p]]==2&&(drupal_visible_users[r].indexOf(drupalchat_uids[drupalchat_ordered_names[p]])>=0)){s+=j(drupalchat_ordered_names[p]);t[drupalchat_uids[drupalchat_ordered_names[p]]]={pictureFilename:drupalchat_pictureFilenames[drupalchat_ordered_names[p]]};q++;}}return{count:q,onlineUsersListHtml:s,onlineUsersList:t};};var i=function(p){for(var q in p){if(p.hasOwnProperty(q)){return false;}}return true;};var m=function(p){return(!i(drupalchat_users[p]));};var f=function(t){delete userPresenceTimeoutIds[t];if(typeof drupalchat_users[t]=="undefined"){return;}if(m(t)){if(typeof drupalchat_msgs_queue[t]!="undefined"){delete drupalchat_msgs_queue[t];}return;}k(t);var q=drupalchat_uids[t];var s=drupalchat_signInState[t];delete drupalchat_users[t];delete drupalchat_names[q];delete drupalchat_fullnames[q];delete drupalchat_uids[t];
delete drupalchat_pictureFilenames[t];delete drupalchat_signInState[t];delete drupal_visible_users[t];var p=drupalchat_ordered_names.indexOf(t);drupalchat_ordered_names.splice(p,1);if(s!=2){return;}for(var u in drupalchat_users){if(drupalchat_signInState[u]==2){for(var r in drupalchat_users[u]){if(settings.debug){}queueAndPublishMessageToClient(r,{type:"userOffline",data:q,callback:"drupalchatNodejsMessageHandler"},"drupalchat");}}}};var d=function(s){if(typeof drupalchat_msgs_queue[s]=="undefined"){return;}for(var q=0;q<drupalchat_msgs_queue[s].length;q++){var r=drupalchat_msgs_queue[s][q].senderSessionId;var p=drupalchat_msgs_queue[s][q].msgForClient;if(typeof drupalchat_users[p.fromUsername]=="undefined"){continue;}p.fromUserPictureFilename=drupalchat_pictureFilenames[p.fromUsername];p.forUserPictureFilename=drupalchat_pictureFilenames[s];p.fromUserStatus=drupalchat_signInState[p.fromUsername];if(settings.debug){}o(r,p);}delete drupalchat_msgs_queue[s];};var k=function(s){if(typeof drupalchat_msgs_queue[s]=="undefined"){return;
}for(var q=0;q<drupalchat_msgs_queue[s].length;q++){var r=drupalchat_msgs_queue[s][q].senderSessionId;var p=drupalchat_msgs_queue[s][q].msgForClient;if(typeof drupalchat_users[p.fromUsername]!="undefined"&&drupalchat_users[p.fromUsername].hasOwnProperty(r)){if(settings.debug){}c(r,p.msgsList,p.forUserId);}else{}}delete drupalchat_msgs_queue[s];};var c=function(t,r,q){var p=[];for(msg in r){p.push(r[msg].id);}var s={msgIdList:p,uid2:q};if(settings.debug){}publishMessageToClient(t,{type:"noReceiverForMsg",data:s,callback:"drupalchatNodejsMessageHandler"});};var o=function(p,q){q.displayAs="S";for(var r in drupalchat_users[q.fromUsername]){if(r!=p){if(settings.debug){}publishMessageToClient(r,{type:"newMessage",data:q,callback:"drupalchatNodejsMessageHandler"});}}q.displayAs="R";for(var r in drupalchat_users[q.forUsername]){if(settings.debug){}publishMessageToClient(r,{type:"newMessage",data:q,callback:"drupalchatNodejsMessageHandler"});}};var h=function(q,p){if(typeof drupalchat_msgs_queue[p.forUsername]=="undefined"){drupalchat_msgs_queue[p.forUsername]=[];
}drupalchat_msgs_queue[p.forUsername].push({senderSessionId:q,msgForClient:p});};process.on("client-authenticated",function(u,s){var y=settings.drupalchatNodejs.currTheme;if(y=="expertusoneV2"){var p="expertusonev2_default_user.png";}else{var p="default_user.png";}if(s.uid>0&&typeof s.name!="undefined"&&s.name!=""){if(settings.debug){}var v=s.picture&&s.picture!=null?s.picture.filename:p;var z=false;if(typeof drupalchat_users[s.name]=="undefined"){g(s.name);drupalchat_users[s.name]={};drupalchat_uids[s.name]=s.uid;drupalchat_names[s.uid]=s.name;drupalchat_fullnames[s.uid]=s.fullname;drupalchat_pictureFilenames[s.name]=v;drupalchat_signInState[s.name]=s.signInState;z=true;}drupal_visible_users[s.name]=s.visibleUserID;if(v!=drupalchat_pictureFilenames[s.name]){process.emit("message-published",{type:"sendPictureFilename",data:'{"uid":"'+s.uid+'","name":"'+s.name+'","pictureFilename":"'+v+'"}'},1);}if(s.signInState!=drupalchat_signInState[s.name]){process.emit("message-published",{type:"signInStateChanged",data:'{"uid":"'+s.uid+'","name":"'+s.name+'","signInState":'+s.signInState+"}"},1);
}drupalchat_users[s.name][u]=u;if(userPresenceTimeoutIds[s.name]){clearTimeout(userPresenceTimeoutIds[s.name]);}delete userPresenceTimeoutIds[s.name];if(s.signInState!=2){if(settings.debug){}k(s.name);return;}if(settings.debug){}d(s.name);var q=l(s.name);if(q.count==0){if(settings.debug){}return;}if(settings.debug){}publishMessageToClient(u,{type:"onlineUsersList",data:q,callback:"drupalchatNodejsMessageHandler"});if(z){var w=a(s.name);for(var t in drupalchat_users){if(t!=s.name&&drupalchat_signInState[t]==2&&(drupal_visible_users[s.name].indexOf(drupalchat_uids[s.name])>=0)){var r=n(t,w);for(var x in drupalchat_users[t]){if(settings.debug){}queueAndPublishMessageToClient(x,{type:"userOnline",data:{uid:s.uid,name:s.name,insertInfo:r},callback:"drupalchatNodejsMessageHandler"},"drupalchat");}}}}}}).on("client-message",function(t,s){if(s.type=="newMessage"){if(s.uid1==0||typeof drupalchat_names[s.uid1]=="undefined"){return;}for(var r in s.msgObjList){var p=s.msgObjList[r];if(drupalchat_signInState[drupalchat_names[s.uid1]]!=2||typeof drupalchat_names[p.uid2]=="undefined"||drupalchat_signInState[drupalchat_names[p.uid2]]!=2){if(settings.debug){}c(t,p.msgsList,p.uid2);
continue;}var q={length:p.msgsList?p.msgsList.length:0,msgsList:p.msgsList||[],forUserId:p.uid2,forUsername:drupalchat_names[p.uid2],forUserFullName:drupalchat_fullnames[p.uid2],forUserPictureFilename:drupalchat_pictureFilenames[drupalchat_names[p.uid2]],fromUserId:s.uid1,fromUsername:drupalchat_names[s.uid1],fromUserFullName:drupalchat_fullnames[s.uid1],fromUserPictureFilename:drupalchat_pictureFilenames[drupalchat_names[s.uid1]]};if(m(q.forUsername)){if(settings.debug){}o(t,q);}else{if(settings.debug){}h(t,q);}}}}).on("message-published",function(x,t){if(x.type=="sendPictureFilename"){var s=JSON.parse(x.data);for(var w in authenticatedClients){if(authenticatedClients[w].name==s.name){if(typeof authenticatedClients[w].picture=="undefined"||authenticatedClients[w].picture==null){authenticatedClients[w].picture={};}authenticatedClients[w].picture.filename=s.pictureFilename;}}if(typeof drupalchat_pictureFilenames[s.name]!="undefined"){drupalchat_pictureFilenames[s.name]=s.pictureFilename;
}for(var r in drupalchat_users){for(var v in drupalchat_users[r]){if(settings.debug){}publishMessageToClient(v,{type:"userPictureChanged",data:{uid:s.uid,pictureFilename:s.pictureFilename},callback:"drupalchatNodejsMessageHandler"});}}}if(x.type=="signInStateChanged"){var s=JSON.parse(x.data);for(var w in authenticatedClients){if(authenticatedClients[w].name==s.name){authenticatedClients[w].signInState=s.signInState;}}if(typeof drupalchat_users[s.name]==="undefined"){return;}if(s.signInState==drupalchat_signInState[s.name]){return;}drupalchat_signInState[s.name]=s.signInState;if(s.signInState==2){var p=l(s.name);var u=a(s.name);for(var r in drupalchat_users){for(var v in drupalchat_users[r]){if(r==s.name){if(settings.debug){}publishMessageToClient(v,{type:"signedIn",data:p,callback:"drupalchatNodejsMessageHandler"});}else{if(drupalchat_signInState[r]==2){var q=n(r,u);queueAndPublishMessageToClient(v,{type:"userOnline",data:{uid:s.uid,name:s.name,insertInfo:q},callback:"drupalchatNodejsMessageHandler"},"drupalchat");
}}}}}else{for(var r in drupalchat_users){for(var v in drupalchat_users[r]){if(r==s.name){if(settings.debug){}dropMsgQueue(v);if(settings.debug){}publishMessageToClient(v,{type:"signedOut",data:{},callback:"drupalchatNodejsMessageHandler"});}else{if(drupalchat_signInState[r]==2){if(settings.debug){}queueAndPublishMessageToClient(v,{type:"userOffline",data:s.uid,callback:"drupalchatNodejsMessageHandler"},"drupalchat");}}}}}}}).on("client-disconnect",function(r){if(settings.debug){}var q="";for(var s in drupalchat_users){for(var p in drupalchat_users[s]){if(p==r){q=s;break;}}if(q==""){continue;}}if(q!=""){if(settings.debug){}delete drupalchat_users[q][r];if(m(q)){return;}if(userPresenceTimeoutIds[q]){clearTimeout(userPresenceTimeoutIds[q]);}delete userPresenceTimeoutIds[q];if(settings.debug){}userPresenceTimeoutIds[q]=setTimeout(f,settings.drupalchatNodejs.eraseUserAfter,q);}}).on("user-logged-out",function(q,u,s,v,p){if(settings.debug){}if(userPresenceTimeoutIds[u]){clearTimeout(userPresenceTimeoutIds[u]);
}delete userPresenceTimeoutIds[u];if(!drupalchat_users.hasOwnProperty(u)){if(v.length>0){}if(settings.debug){}return;}for(var r=0;r<v.length;r++){var t=v[r];if(drupalchat_users[u].hasOwnProperty(t)){if(settings.debug){}publishMessageToClient(t,{type:"loggedOut",data:{},callback:"drupalchatNodejsMessageHandler"});delete drupalchat_users[u][t];}else{}}if(m(u)||p){return;}f(u);}).on("render-message",function(t,r,s){if(s!="drupalchat"||typeof r.type=="undefined"){return;}var p=settings.drupalchatNodejs.currTheme;if(p=="expertusoneV2"){var q="expertusonev2_default_user.png";}else{var q="default_user.png";}switch(r.type){case"userOnline":r.data.pictureFilename=typeof drupalchat_users[r.data.name]=="undefined"?q:drupalchat_pictureFilenames[r.data.name];r.data.onlineUserHTML=j(r.data.name,r.data.uid,r.data.pictureFilename);break;case"userOffline":break;}});};